<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>VRTrack QC</title>
        
        <!-- jQuery for REST interaction, and needed by bootstrap.js -->
        <script src="/js/jquery-1.12.0.min.js"></script>
        
        <!-- Bootstrap for presentation and styling -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/css/bootstrap-3.3.4.min.css">
        <script src="/js/bootstrap-3.3.4.min.js"></script>
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
          <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
        
        <!-- Knockout for event handling -->
        <script src="/js/knockout-3.4.0.min.js"></script>
        <script src="/js/knockout-switch-case.min.js"></script>
        <script src="/js/knockstrap-1.3.1.min.js"></script>
        <script src="/js/knockout-progressivefilter.min.js"></script>
        
        <!-- Bootstrap Multiselect for nice selects -->
        <script src="/js/bootstrap-multiselect-0.9.8.min.js"></script>
        <link rel="stylesheet" href="/css/bootstrap-multiselect-0.9.8.css">
        
        <!-- Simrou for client-side navigation -->
        <script src="/js/simrou-1.5.4.min.js"></script>
        
        <!-- js.cookie for cookie get/setting -->
        <script src="/js/js.cookie-2.1.0.js"></script>
        
        <!-- Some of our own general helper functions -->
        <script src="/js/vrpipe.js"></script>
        <link rel="stylesheet" href="/css/vrpipe.css">
        
        <!-- vrtrack_qc functions -->
        <script src="/pages/vrtrack_qc/qc.js"></script>
    </head>
    <body>
        <div id="nav" class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <span class="navbar-brand" style="cursor: pointer"  onclick="window.location = '/'">&laquo;</span>
                    <span class="navbar-brand" style="cursor: pointer" onclick="window.location = '/pages/vrtrack_qc'">VRTrack QC</span>
                </div>
                
                <script type="text/html" src="/login_template.html" id="login-template"></script>
                <div data-bind="template: { name: 'login-template' }"></div>
            </div>
        </div>
        
        <div class="container-fluid">
            <div id="qc">
                <div data-bind="loadingWhen: loading().length">
                    &nbsp;
                </div>
                
                <button class="btn btn-default btn-sm bottom-margin" type="button" data-bind="visible: groupConfig().length || adminUsers, click: toggleAdmin">
                    <span>administration</span> <span class="caret"></span>
                </button>
                
                <div id="admintoggle" class="well" data-bind="visible: adminToggle">
                    <div id="admin" data-bind="visible: adminUsers" class="panel panel-default">
                        <div class="panel-body">
                            <form class="panel panel-default">
                                <div class="input-group panel-body">
                                    <span class="input-group-addon" data-toggle="tooltip" data-container="body" title="Enter one or more space or comma separated unix usernames to set who can administer the QC website.">admin(s)</span>
                                    <input type="text" class="form-control" data-bind="value: adminUsers">
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" type="submit"><span class="glyphicon glyphicon-play-circle"></span></button>
                                    </span>
                                </div>
                            </form>
                                
                            <div id="groupadmins" data-bind="visible: groupAdmins().length" class="panel panel-default">
                                <div class="panel-heading">Group Admins</div>
                                <div class="panel-body">
                                    <div data-bind="foreach: groupAdmins">
                                        <form data-bind="submit: function(formElement) { formElement.find('button[type=submit]').trigger('click'); }">
                                            <div class="input-group">
                                                <span class="input-group-addon" data-toggle="tooltip" data-container="body" title="Enter one or more space or comma separated unix usernames to set who can administer this group." data-bind="text: group"></span>
                                                <input type="text" class="form-control" data-bind="value: users">
                                                <span class="input-group-btn">
                                                    <button class="btn btn-default" type="submit" data-bind="click: $parent.updateGroupAdmins"><span class="glyphicon glyphicon-play-circle"></span></button>
                                                </span>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="groupconfig" data-bind="visible: groupConfig().length" class="panel panel-default">
                        <div class="panel-heading">Group QC Failure Reasons</div>
                        <div class="panel-body">
                            <div data-bind="foreach: groupConfig">
                                <form data-bind="submit: function(formElement) { formElement.find('button[type=submit]').trigger('click'); }">
                                    <div class="input-group">
                                        <span class="input-group-addon" data-toggle="tooltip" data-container="body" title="Enter one or more comma separated possible reasons for QC failure of samples in this group." data-bind="text: group"></span>
                                        <input type="text" class="form-control" data-bind="value: qc_fail_reasons">
                                        <span class="input-group-btn">
                                            <button class="btn btn-default" type="submit" data-bind="click: $parent.updateGroupConfig"><span class="glyphicon glyphicon-play-circle"></span></button>
                                        </span>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="selector">
                    <form role="form" class="input-group btn-group">
                        <span class="input-group-addon"><b>Group</b></span>
                        <select size="2" id="groupSelect" class="multiselect" multiple="multiple" data-bind="
                            options: groupNodes,
                            optionsText: function(item) {
                                return item.properties['name']
                            },
                            optionsValue: function(item) {
                                return +item.id
                            },
                            selectedOptions: selectedGroups,
                            multiselect: true">
                        </select>
                    </form>
                    
                    <form role="form" class="input-group btn-group top-margin" data-bind="visible: selectedGroups().length">
                        <span class="input-group-addon"><b>Study</b></span>
                        <select size="2" id="studyPropertySelect" class="multiselect" data-bind="
                            options: studyProperties,
                            selectedOptions: selectedStudyProperty,
                            multiselect: true">
                        </select>
                        <select size="2" id="studySelect" class="multiselect" multiple="multiple" data-bind="
                            options: studyNodesForSelect,
                            optionsText: 'property',
                            optionsValue: function(item) {
                                return +item.id
                            },
                            selectedOptions: selectedStudies,
                            multiselect: true">
                        </select>
                    </form>
                    
                    <div data-bind="visible: selectedStudies().length">
                        <form role="form" class="input-group btn-group top-margin">
                            <span class="input-group-addon">Donor</span>
                            <select size="2" id="donorPropertySelect" class="multiselect" data-bind="
                                options: donorProperties,
                                selectedOptions: selectedDonorProperty,
                                multiselect: true">
                            </select>
                            <select size="2" id="donorSelect" class="multiselect" multiple="multiple" data-bind="
                                options: donorNodesForSelect,
                                optionsText: 'property',
                                optionsValue: function(item) {
                                    return +item.id
                                },
                                selectedOptions: selectedDonors,
                                multiselect: true">
                            </select>
                        </form>
                        
                        <form role="form" class="input-group btn-group top-margin">
                            <span class="input-group-addon">Sample</span>
                            <select size="2" id="samplePropertySelect" class="multiselect" data-bind="
                                options: sampleProperties,
                                selectedOptions: selectedSampleProperty,
                                multiselect: true">
                            </select>
                            <select size="2" id="sampleSelect" class="multiselect" multiple="multiple" data-bind="
                                options: sampleNodesForSelect,
                                optionsText: 'property',
                                optionsValue: function(item) {
                                    return +item.id
                                },
                                selectedOptions: selectedSamples,
                                multiselect: true">
                            </select>
                        </form>
                        
                        <form role="form" class="input-group btn-group top-margin">
                            <span class="input-group-addon"><b>View</b></span>
                            <select size="2" id="viewSelect" class="multiselect" data-bind="
                                options: viewLabels,
                                selectedOptions: selectedViewLabel,
                                multiselect: true">
                            </select>
                        </form>
                    </div>
                </div>
                
                <div class="top-margin" id="errors" data-bind="foreach: errors">
                    <div class="alert alert-danger fade in">
                        <p data-bind="text: $data"></p>
                    </div>
                </div>
                
                <div id="viewtable" data-bind="visible: viewNodes().length">
                    <hr>
                    
                    <!-- ko if: selectedViewLabel() != 'Donor' -->
                        <form role="form" class="btn-group top-margin" style="width: 100%">
                            <div>
                                <button data-toggle="dropdown" class="btn btn-default btn-sm dropdown-toggle" type="button">
                                    <span>columns</span> <span class="caret"></span>
                                </button>
                                <ul role="menu" class="dropdown-menu list-inline" data-bind="foreach: viewColumns">
                                    <li style="padding:0; margin:0; width:100px">
                                        <a href="#" class="small" data-bind="click: $parent.toggleColumn, clickBubble: false">
                                            <input type="checkbox" data-bind="checked: display"> <span class="small" data-bind="text: header"></span>
                                        </a>
                                    </li>
                                </ul>
                                
                                <button class="btn btn-default btn-sm" type="button" data-bind="click: rememberColumns.bind($data, false)"><span>save for this selection</span></button>
                                <button class="btn btn-default btn-sm" type="button" data-bind="click: rememberColumns.bind($data, true)"><span>save as default</span></button>
                            </div>
                        </form>
                        
                        <!-- ko if: selectedViewLabel() == 'Lanelet' && columns()['Auto QC'].display -->
                            <form role="form" class="btn-group top-margin form-inline" style="width: 100%">
                            <div>
                                <button id="autoQCSettingsMenuButton" class="btn btn-default btn-sm dropdown-toggle" type="button">
                                    <span>Auto QC settings</span> <span class="caret"></span>
                                </button>
                                <ul id="autoQCSettingsMenu" role="menu" class="dropdown-menu list-inline" data-bind="foreach: autoQCConfigKeys" style="padding: 0 0 5px 0;">
                                    <li class="autoQCSettingsMenuItem" style="padding: 0; margin: 0;">
                                        <div class="input-group input-group-sm autoQCSettingsMenuItem" style="float: left; padding: 0; margin: 5px -5px -5px 5px;">
                                            <div class="input-group-addon autoQCSettingsMenuItem"><abbr class="autoQCSettingsMenuItem" data-bind="text: $data, attr: { title: $parent.autoQCSettings[$data].desc }"></abbr></div>
                                            <input type="text" class="form-control autoQCSettingsMenuItem" data-bind="value: $parent.autoQCSettings[$data].value, attr: { size: $parent.autoQCSettings[$data].size }">
                                        </div>
                                    </li>
                                </ul>
                                
                                <button class="btn btn-default btn-sm" type="button" data-bind="click: setUserAutoQCSettings.bind($data, false), css: aqcSelectionButtonClass"><span>save for this selection</span></button>
                                <button id="aqc_study_button" class="btn btn-default btn-sm" type="button" data-bind="click: setStudyAutoQCSettings, css: aqcStudyButtonClass"><span>save for <span data-bind="text: selectedStudies().length > 1 ? 'these studies' : 'this study'"></span></span></button>
                                <button class="btn btn-default btn-sm" type="button" data-bind="click: setUserAutoQCSettings.bind($data, true), css: aqcDefaultButtonClass"><span>save as my default</span></button>
                                <button class="btn btn-default btn-sm" type="button" data-bind="click: revertAutoQCSettings"><span>revert</span></button>
                            </div>
                        </form>
                        <!-- /ko -->
                        
                        <form role="form" class="top-margin bottom-margin">
                            <label class="checkbox-inline">
                                <input type="checkbox" data-bind="checked: showAllGraphs" /> show all graphs
                            </label>
                            <label class="checkbox-inline">
                                <input type="checkbox" data-bind="checked: showAllStats" /> show all stats
                            </label>
                        </form>
                    <!-- /ko -->
                    
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <span data-bind="text: selectedViewLabel"></span>
                            <small data-bind="if: selectedViewLabel">
                                <!-- ko if: selectedViewLabel() != 'Donor' -->
                                    &nbsp;(<span data-bind="text: filteredNodes.trueLength"></span> / <span data-bind="text: viewNodes().length"></span>)
                                <!-- /ko -->
                            </small>
                        </div>
                        
                        <div data-bind="templateWithOptions: { name: 'viewNodes-template', templateOptions: { mode: selectedViewLabel(), nodes: viewNodes() } }"></div>
                        
                        <script type="text/html" id="viewNodes-template">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-condensed small">
                                    <thead>
                                        <tr data-bind="foreach: viewColumns">
                                            <!-- ko if: display() && ($parent.options.mode == 'Sample' ? (! $parent.sampleExcludedColumns().hasOwnProperty(header)) : true) -->
                                                <th data-bind="sort: { arr: $parent.options.nodes, prop: sortOn, postFunc: $parent.updateFilter }">
                                                    <!-- ko if: desc -->
                                                        <abbr data-bind="text: header, attr: { title: desc }"></abbr>
                                                    <!-- /ko -->
                                                    <!-- ko ifnot: desc -->
                                                        <span data-bind="text: header"></span>
                                                    <!-- /ko -->
                                                </th>
                                            <!-- /ko -->
                                        </tr>
                                        
                                        <!-- ko if: options.mode != 'Donor' && columns() && columns()['Pass'] && numColumns() > 0 -->
                                            <tr style="background-color:#F5F5F5">
                                                <!-- ko if: columns()['Pass'].display -->
                                                    <td>
                                                        <label class="radio-highlightable"> <!-- just to get the alignment similar to the radios in body column beneath -->
                                                            <input type="checkbox" data-bind="checked: laneletFilters['passed']" />
                                                        </label>
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Fail'].display -->
                                                    <td>
                                                        <label class="radio-highlightable">
                                                            <input type="checkbox" data-bind="checked: laneletFilters['failed']" />
                                                        </label>
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Invst'].display -->
                                                    <td>
                                                        <label class="radio-highlightable">
                                                            <input type="checkbox" data-bind="checked: laneletFilters['investigate']" />
                                                        </label>
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['GTPend'].display -->
                                                    <td>
                                                        <label class="radio-highlightable">
                                                            <input type="checkbox" data-bind="checked: laneletFilters['gt_pending']" />
                                                        </label>
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Pend'].display -->
                                                    <td>
                                                        <label class="radio-highlightable">
                                                            <input type="checkbox" data-bind="checked: laneletFilters['pending']" />
                                                        </label>
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Study ID'].display -->
                                                    <td>
                                                        <input type="text" size="6" data-bind="textInput: laneletFilters['study_id']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Study Name'].display -->
                                                    <td>
                                                        <input type="text" size="6" data-bind="textInput: laneletFilters['study_name']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Study Acc'].display -->
                                                    <td>
                                                        <input type="text" size="6" data-bind="textInput: laneletFilters['study_acc']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Individual'].display -->
                                                    <td>
                                                        <input type="text" size="6" data-bind="textInput: laneletFilters['individual']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Sample'].display -->
                                                    <td>
                                                        <input type="text" size="6" data-bind="textInput: laneletFilters['sample']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Sample Acc'].display -->
                                                    <td>
                                                        <input type="text" size="6" data-bind="textInput: laneletFilters['sample_acc']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Sample Suppl'].display -->
                                                    <td>
                                                        <input type="text" size="6" data-bind="textInput: laneletFilters['sample_sn']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Library'].display -->
                                                    <td>
                                                        <input type="text" size="6" data-bind="textInput: laneletFilters['library']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Lanelet'].display -->
                                                    <td>
                                                        <input type="text" size="6" data-bind="textInput: laneletFilters['lanelet']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Gender'].display -->
                                                    <td>
                                                        <input type="text" size="6" data-bind="textInput: laneletFilters['gender']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: options.mode == 'Lanelet' -->
                                                    <!-- ko if: columns()['Genotype'].display -->
                                                        <td>
                                                            <select data-bind="value: laneletFilters['genotype']">
                                                                <option value="all">all</option>
                                                                <option value="confirmed">confirmed</option>
                                                                <option value="unconfirmed">unconfirmed</option>
                                                                <option value="unchecked">unchecked</option>
                                                                <option value="unknown">unknown</option>
                                                                <option value="candidate">candidate</option>
                                                                <option value="wrong">wrong</option>
                                                            </select>
                                                        </td>
                                                    <!-- /ko -->
                                                    <!-- ko if: columns()['Verify Bam ID'].display -->
                                                        <td>
                                                            <select data-bind="value: laneletFilters['verify_bam_id']">
                                                                <option value="all">all</option>
                                                                <option value="pass">pass</option>
                                                                <option value="fail">fail</option>
                                                                <option value="unsure">unsure</option>
                                                                <option value="unknown">unknown</option>
                                                            </select>
                                                        </td>
                                                    <!-- /ko -->
                                                    <!-- ko if: columns()['NPG Status'].display -->
                                                        <td>
                                                            <select data-bind="value: laneletFilters['npg_status']">
                                                                <option value="all">all</option>
                                                                <option value="pass">pass</option>
                                                                <option value="fail">fail</option>
                                                                <option value="unknown">unknown</option>
                                                            </select>
                                                        </td>
                                                    <!-- /ko -->
                                                    <!-- ko if: columns()['Auto QC'].display -->
                                                        <td>
                                                            <select data-bind="value: laneletFilters['auto_qc']">
                                                                <option value="all">all</option>
                                                                <option value="pass">pass</option>
                                                                <option value="fail">fail</option>
                                                            </select>
                                                        </td>
                                                    <!-- /ko -->
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Raw Gb'].display -->
                                                    <td>
                                                        <input type="text" size="2" data-bind="textInput: laneletFilters['raw_gb']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Mapped Gb'].display -->
                                                    <td>
                                                        <input type="text" size="2" data-bind="textInput: laneletFilters['mapped_gb']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Dup%'].display -->
                                                    <td>
                                                        <input type="text" size="2" data-bind="textInput: laneletFilters['dup_percent']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Mapped-dups Gb'].display -->
                                                    <td>
                                                        <input type="text" size="2" data-bind="textInput: laneletFilters['mapped_dups_gb']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Overlap dup%'].display -->
                                                    <td>
                                                        <input type="text" size="2" data-bind="textInput: laneletFilters['overlap_dup_percent']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Net Gb'].display -->
                                                    <td>
                                                        <input type="text" size="2" data-bind="textInput: laneletFilters['net_gb']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Depth'].display -->
                                                    <td>
                                                        <input type="text" size="2" data-bind="textInput: laneletFilters['depth']" />
                                                    </td>
                                                <!-- /ko -->
                                                <!-- ko if: columns()['Error Rate%'].display -->
                                                    <td>
                                                        <input type="text" size="2" data-bind="textInput: laneletFilters['error_rate']" />
                                                    </td>
                                                <!-- /ko -->
                                                <td></td>
                                            </tr>
                                        <!-- /ko -->
                                    </thead>
                                    <!-- ko if: options.mode != 'Donor' -->
                                        <!-- for speed we must explicitly specify every column -->
                                        <tbody data-bind="if:  columns() && columns()['Pass']">
                                            <!-- ko foreach: filteredNodes -->
                                                <tr data-bind="css: { success: $parent.options.mode == 'Sample' && Pass == Lanelet }">
                                                    <!-- ko if: $parent.columns()['Pass'].display -->
                                                        <td>
                                                            <!-- ko if: $parent.options.mode == 'Lanelet' -->
                                                                <div class="radio-highlightable" data-bind="attr: {'id': Lanelet + '_passed'}">
                                                                    <input type="radio" value="passed" data-bind="checked: new_qcgrind_qc_status, enable: is_admin, click: $parent.changeQCStatus.bind($data, 'passed')" />
                                                                </div>
                                                            <!-- /ko -->
                                                            <!-- ko if: $parent.options.mode == 'Sample' -->
                                                                <span data-bind="text: Pass"></span>
                                                            <!-- /ko -->
                                                        </td>
                                                    <!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Fail'].display -->
                                                        <td>
                                                            <!-- ko if: $parent.options.mode == 'Lanelet' -->
                                                                <div class="radio-highlightable" data-bind="attr: {'id': Lanelet + '_failed'}">
                                                                    <input type="radio" value="failed" data-bind="checked: new_qcgrind_qc_status, enable: is_admin, click: $parent.changeQCStatus.bind($data, 'failed')" />
                                                                </div>
                                                            <!-- /ko -->
                                                            <!-- ko if: $parent.options.mode == 'Sample' -->
                                                                <span data-bind="text: Fail"></span>
                                                            <!-- /ko -->
                                                        </td>
                                                    <!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Invst'].display -->
                                                        <td>
                                                            <!-- ko if: $parent.options.mode == 'Lanelet' -->
                                                                <div class="radio-highlightable" data-bind="attr: {'id': Lanelet + '_investigate'}">
                                                                    <input type="radio" value="investigate" data-bind="checked: new_qcgrind_qc_status, enable: is_admin, click: $parent.changeQCStatus.bind($data, 'investigate')" />
                                                                </div>
                                                            <!-- /ko -->
                                                            <!-- ko if: $parent.options.mode == 'Sample' -->
                                                                <span data-bind="text: Invst"></span>
                                                            <!-- /ko -->
                                                        </td>
                                                    <!-- /ko -->
                                                    <!-- ko if: $parent.columns()['GTPend'].display -->
                                                        <td>
                                                            <!-- ko if: $parent.options.mode == 'Lanelet' -->
                                                                <div class="radio-highlightable" data-bind="attr: {'id': Lanelet + '_gt_pending'}">
                                                                    <input type="radio" value="gt_pending" data-bind="checked: new_qcgrind_qc_status, enable: is_admin, click: $parent.changeQCStatus.bind($data, 'gt_pending')" />
                                                                </div>
                                                            <!-- /ko -->
                                                            <!-- ko if: $parent.options.mode == 'Sample' -->
                                                                <span data-bind="text: GTPend"></span>
                                                            <!-- /ko -->
                                                        </td>
                                                    <!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Pend'].display -->
                                                        <td>
                                                            <!-- ko if: $parent.options.mode == 'Lanelet' -->
                                                                <div class="radio-highlightable" data-bind="attr: {'id': Lanelet + '_pending'}">
                                                                    <input type="radio" value="pending" data-bind="checked: new_qcgrind_qc_status, enable: is_admin, click: $parent.changeQCStatus.bind($data, 'pending')" />
                                                                </div>
                                                            <!-- /ko -->
                                                            <!-- ko if: $parent.options.mode == 'Sample' -->
                                                                <span data-bind="text: Pend"></span>
                                                            <!-- /ko -->
                                                        </td>
                                                    <!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Study ID'].display --><td style="cursor: pointer" data-bind="text: study_id, click: $parent.setFilter.bind($data, 'study_id', study_id)"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Study Name'].display --><td style="cursor: pointer" data-bind="text: study_name, click: $parent.setFilter.bind($data, 'study_name', study_name)"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Study Acc'].display --><td style="cursor: pointer" data-bind="text: study_acc, click: $parent.setFilter.bind($data, 'study_acc', study_acc)"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Individual'].display --><td style="cursor: pointer" data-bind="text: Individual, click: $parent.setFilter.bind($data, 'individual', Individual)"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Sample'].display --><td style="cursor: pointer" data-bind="text: Sample, click: $parent.setFilter.bind($data, 'sample', Sample)"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Sample Acc'].display --><td style="cursor: pointer" data-bind="text: sample_acc, click: $parent.setFilter.bind($data, 'sample_acc', sample_acc)"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Sample Suppl'].display --><td style="cursor: pointer" data-bind="text: sample_sn, click: $parent.setFilter.bind($data, 'sample_sn', sample_sn)"></td><!-- /ko -->
                                                    <!-- ko if: $parent.options.mode == 'Lanelet' -->
                                                        <!-- ko if: $parent.columns()['Library'].display --><td style="cursor: pointer" data-bind="text: Library, click: $parent.setFilter.bind($data, 'library', Library)"></td><!-- /ko -->
                                                        <!-- ko if: $parent.columns()['Lanelet'].display --><td style="cursor: pointer" data-bind="text: Lanelet, css: { success: new_qcgrind_qc_status() == 'passed', danger: new_qcgrind_qc_status() == 'failed', info: new_qcgrind_qc_status() == 'investigate' }, click: $parent.setFilter.bind($data, 'lanelet', run_and_lane)"></td><!-- /ko -->
                                                    <!-- /ko -->
                                                    <!-- ko if: $parent.options.mode == 'Sample' -->
                                                        <!-- ko if: $parent.columns()['Library'].display --><td data-bind="text: Library"></td><!-- /ko -->
                                                        <!-- ko if: $parent.columns()['Lanelet'].display --><td data-bind="text: Lanelet"></td><!-- /ko -->
                                                    <!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Gender'].display --><td data-bind="text: Gender, click: $parent.setFilter.bind($data, 'Gender', Gender)"></td><!-- /ko -->
                                                    <!-- ko if: $parent.options.mode == 'Lanelet' -->
                                                        <!-- ko if: $parent.columns()['Genotype'].display -->
                                                            <td data-bind="css: { warning: Genotype.startsWith('unconfirmed'), danger: Genotype.startsWith('wrong'), success: Genotype.startsWith('confirmed') }">
                                                                <span style="cursor: pointer" data-bind="text: Genotype, popover: { content: $parent.genotypePopover($data), container: 'body', html: true, placement: 'top' }"></span>
                                                            </td>
                                                        <!-- /ko -->
                                                        <!-- ko if: $parent.columns()['Verify Bam ID'].display -->
                                                            <td data-bind="css: { success: $data['Verify Bam ID'].startsWith('pass'), danger: $data['Verify Bam ID'].startsWith('fail'), warning: $data['Verify Bam ID'].startsWith('unsure') }">
                                                                <span style="cursor: pointer" data-bind="text: $data['Verify Bam ID'], popover: { content: $parent.verifyPopover($data), container: 'body', html: true, placement: 'top' }"></span>
                                                            </td>
                                                        <!-- /ko -->
                                                        <!-- ko if: $parent.columns()['NPG Status'].display -->
                                                            <td data-bind="css: { success: $data['NPG Status'] == 'pass', danger: $data['NPG Status'] == 'fail' }">
                                                                <a data-bind="text: $data['NPG Status'], attr: { href: 'http://npg.sanger.ac.uk/perl/npg/run/' + run }" target="_blank" class="text-default"></a>
                                                            </td>
                                                        <!-- /ko -->
                                                        <!-- ko if: $parent.columns()['Auto QC'].display -->
                                                            <td data-bind="css: { success: auto_qc()[0] == 'pass', danger: auto_qc()[0] == 'fail' }">
                                                                <!-- ko switch: auto_qc()[0] -->
                                                                    <!-- ko case: 'fail' -->
                                                                        <span style="cursor: pointer" data-bind="text: auto_qc()[0], popover: { content: $parent.autoQCPopover($data), container: 'body', html: true, placement: 'top' }"></span>
                                                                    <!-- /ko -->
                                                                    <!-- ko case: $default -->
                                                                        <span data-bind="text: auto_qc()[0]"></span>
                                                                    <!-- /ko -->
                                                                <!-- /ko -->
                                                            </td>
                                                        <!-- /ko -->
                                                    <!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Raw Gb'].display --><td data-bind="text: $data['Raw Gb']"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Mapped Gb'].display --><td data-bind="text: $data['Mapped Gb']"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Dup%'].display --><td data-bind="text: $data['Dup%']"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Mapped-dups Gb'].display --><td data-bind="text: $data['Mapped-dups Gb']"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Overlap dup%'].display --><td data-bind="text: $data['Overlap dup%']"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Net Gb'].display --><td data-bind="text: $data['Net Gb']"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Depth'].display --><td data-bind="text: $data['Depth']"></td><!-- /ko -->
                                                    <!-- ko if: $parent.columns()['Error Rate%'].display --><td data-bind="text: $data['Error Rate']"></td><!-- /ko -->
                                                    <td>
                                                        <!-- ko if: $parent.options.mode == 'Lanelet' -->
                                                            <span style="cursor: pointer" data-bind="click: $parent.toggleLaneletGraphs">&laquo;graphs&raquo;</span>
                                                            <span style="cursor: pointer" data-bind="click: $parent.toggleLaneletStats">&laquo;stats&raquo;</span>
                                                        <!-- /ko -->
                                                        <!-- ko if: $parent.options.mode == 'Sample' -->
                                                            <span style="cursor: pointer" data-bind="click: $parent.toggleLanelets">&laquo;lanelets&raquo;</span>
                                                        <!-- /ko -->
                                                    </td>
                                                </tr>
                                                <!-- ko if: $parent.options.mode == 'Lanelet' -->
                                                    <!-- ko if: display_graphs -->
                                                        <tr>
                                                            <td data-bind="attr: { colspan: $parent.numColumns() + 1 }">
                                                                <div class="img-row" data-bind="foreach: qc_plots">
                                                                    <div>
                                                                        <img class="img-thumbnail img-row-img" tabindex="1" data-bind="attr: { src: src, alt: alt, title: alt }">
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    <!-- /ko -->
                                                    <!-- ko if: display_stats -->
                                                        <tr>
                                                            <td data-bind="attr: { colspan: $parent.numColumns() + 1 }">
                                                                <table class="table table-bordered table-striped table-hover table-condensed small" style="margin-bottom: 0">
                                                                    <tbody>
                                                                        <tr>
                                                                            <th>Total Reads</th><td data-bind="text: $data['reads']"></td>
                                                                            <th>Total Bases</th><td data-bind="text: $data['bases']"></td>
                                                                            <th>Cycles</th><td data-bind="text: $data['cycles']"></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>Reads paired</th><td data-bind="text: $data['reads_paired']"></td>
                                                                            <th>Bases postclip</th><td data-bind="text: $data['bases_postclip']"></td>
                                                                            <th>Duplication rate</th><td data-bind="text: $data['duplication_rate']"></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>Reads mapped</th><td data-bind="text: $data['reads_mapped']"></td>
                                                                            <th>Bases mapped</th><td data-bind="text: $data['bases_mapped']"></td>
                                                                            <th>Error rate</th><td data-bind="text: $data['error_rate']"></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>Reads mapped (rmdup)</th><td data-bind="text: $data['reads_mapped_rmdup']"></td>
                                                                            <th>Bases mapped (rmdup)</th><td data-bind="text: $data['bases_mapped_rmdup']"></td>
                                                                            <th></th><td></td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </td>
                                                        </tr>
                                                    <!-- /ko -->
                                                <!-- /ko -->
                                                <!-- ko if: $parent.options.mode == 'Sample' && display_lanelets -->
                                                    <tr>
                                                        <td data-bind="attr: { colspan: $parent.numColumns() + 1 }">
                                                            <div data-bind="templateWithOptions: { name: 'viewNodes-template', data: $root, templateOptions: { mode: 'Lanelet', nodes: lanelets } }"></div>
                                                        </td>
                                                    </tr>
                                                <!-- /ko -->
                                            <!-- /ko -->
                                            <!-- ko if: options.mode == 'Lanelet' && isGroupAdmin && filteredNodes().length > 1 && numQCColumns() > 0 -->
                                                <tr>
                                                    <!-- ko if: columns()['Pass'].display -->
                                                        <td>
                                                            <div class="radio-highlightable">
                                                                <input type="radio" value="passed" data-bind="checked: setAllQCGrindQCStatus" />
                                                            </div>
                                                        </td>
                                                    <!-- /ko -->
                                                    <!-- ko if: columns()['Fail'].display -->
                                                        <td>
                                                            <div class="radio-highlightable">
                                                                <input type="radio" value="failed" data-bind="checked: setAllQCGrindQCStatus" />
                                                            </div>
                                                        </td>
                                                    <!-- /ko -->
                                                    <!-- ko if: columns()['Invst'].display -->
                                                        <td>
                                                            <div class="radio-highlightable">
                                                                <input type="radio" value="investigate" data-bind="checked: setAllQCGrindQCStatus" />
                                                            </div>
                                                        </td>
                                                    <!-- /ko -->
                                                    <!-- ko if: columns()['GTPend'].display -->
                                                        <td>
                                                            <div class="radio-highlightable">
                                                                <input type="radio" value="gt_pending" data-bind="checked: setAllQCGrindQCStatus" />
                                                            </div>
                                                        </td>
                                                    <!-- /ko -->
                                                    <!-- ko if: columns()['Pend'].display -->
                                                        <td>
                                                            <div class="radio-highlightable">
                                                                <input type="radio" value="pending" data-bind="checked: setAllQCGrindQCStatus" />
                                                            </div>
                                                        </td>
                                                    <!-- /ko -->
                                                    <td data-bind="attr: { colspan: numColumns() - numQCColumns() + 1 }">
                                                        <button class="btn btn-info btn-sm" type="submit" data-bind="click: setAllQCGrindQC, disable: setAllQCGrindQCStatus() == 'unset'">Set above to: <span data-bind="text: setAllQCGrindQCStatus"></span></button>
                                                    </td>
                                                </tr>
                                            <!-- /ko -->
                                        </tbody>
                                    <!-- /ko -->
                                    <!-- ko if: options.mode == 'Donor' -->
                                        <tbody data-bind="foreach: options.nodes">
                                            <tr style="cursor: pointer" data-bind="foreach: $parent.viewColumns, click: $parent.showQCForNode">
                                                <td data-bind="text: $parent[text]"></td>
                                            </tr>
                                        </tbody>
                                    <!-- /ko -->
                                </table>
                            </div>
                            <div class="panel-footer">
                                <small data-bind="if: selectedViewLabel">
                                    <!-- ko switch: selectedViewLabel -->
                                        <!-- ko case: 'Donor' -->
                                            <span data-bind="text: options.nodes.length"></span> Donors
                                        <!-- /ko -->
                                        <!-- ko case: $default -->
                                            <span data-bind="text: filteredNodes.trueLength"></span> / <span data-bind="text: options.nodes.length"></span> <span data-bind="text: selectedViewLabel"></span>s
                                            <!-- ko if: filteredNodes.trueLength() > maxRows() -->
                                                (showing <span data-bind="text: filteredNodes().length"></span>)
                                                <!-- ko if: filteredNodes.trueLength() > maxRows() + 750 -->
                                                    <button class="btn btn-info btn-sm" type="submit" data-bind="click: showMoreNodes">show 500 more</button>
                                                <!-- /ko -->
                                                <button class="btn btn-info btn-sm" type="submit" data-bind="click: showAllNodes">show all</button>
                                            <!-- /ko -->
                                        <!-- /ko -->
                                    <!-- /ko -->
                                </small>
                            </div>
                        </script>
                    </div>
                </div>
            </div>
            
            <hr>
            
            <footer id="footer">
                <small>&copy; 2014-2016 Genome Research Limited.</small>
            </footer>
        </div>
        
        <script type="text/javascript">
            var router = new Simrou();
            $('[data-toggle="popover"]').popover();
            $('html').on('click', function(e) {
                if ($(e.target).data('original-title') === undefined && !$(e.target).parents().is('.popover.in')) {
                    $('[data-original-title]').popover('hide');
                }
            });
            $(document).keyup(function (event) {
                if (event.which === 27) {
                    $('[data-original-title]').popover('hide');
                }
            });
            $(document).on('mouseup', '.btn, img', function(){
                $(this).blur();
            });
            
            $(document).on('click', '#autoQCSettingsMenuButton', function() {
                $(this).parent().toggleClass('open');
            });
            $('body').on('click', function(e) {
                if (!$('#autoQCSettingsMenuButton, #autoQCSettingsMenuButton span, #autoQCSettingsMenu, .autoQCSettingsMenuItem').is(e.target) && $('#autoQCSettingsMenuButton').parent().hasClass('open')) {
                    $('#autoQCSettingsMenuButton').parent().removeClass('open');
                }
            });
            
            // viewmodel for logging in
            var livm = new ko.LogInViewModel();
            loadExternalKnockoutTemplates(function() {
                ko.applyBindings(livm, $('#nav')[0]);
            });
            
            // viewmodel for qc
            function QCViewModel() {
                "use strict";
                var self = this;
                
                self.loading = ko.observableArray();
                self.errors = ko.observableArray();
                self.labels = ko.observableArray();
                self.labelProperties = {};
                self.viewLabels = ko.observableArray();
                self.adminToggle = ko.observable(false);
                self.adminUsers = ko.observable();
                self.groupAdmins = ko.observableArray();
                self.isGroupAdmin = ko.observable(false);
                self.groupConfig = ko.observableArray();
                
                // toggle display of the admin well when user clicks the button
                self.toggleAdmin = function() {
                    self.adminToggle(! self.adminToggle());
                };
                
                // some selects show node properties sorted by the selected
                // property, so we'll have computed vars that build their arrays
                // using this function
                self.nodesToSelect = function(nodes, property, selectID) {
                    var arr = [];
                    if (property) {
                        property = property[0];
                        var i;
                        var nlen = nodes().length;
                        var node;
                        for (i = 0; i < nlen; i += 1) {
                            node = nodes()[i];
                            arr.push({ id: node.id, property: node.properties[property] });
                        }
                        arr.sort(function(left, right) {
                            return left.property === right.property ? (left.id < right.id ? -1 : 1) : (left.property < right.property ? -1 : 1);
                        });
                    }
                    
                    setTimeout(function(){
                        $(selectID).multiselect('rebuild');
                    }, 10);
                    
                    return arr;
                };
                
                // required group and study selection vars
                self.groupNodes = ko.observableArray();
                self.selectedGroups = ko.observableArray();
                self.studyProperties = ko.observableArray();
                self.selectedStudyProperty = ko.observable();
                self.studyNodes = ko.observableArray();
                self.studyNodesForSelect = ko.computed(function() { return self.nodesToSelect(self.studyNodes, self.selectedStudyProperty(), '#studySelect'); });
                self.selectedStudies = ko.observableArray();
                
                // optional donor and sample selection vars
                self.donorProperties = ko.observableArray();
                self.selectedDonorProperty = ko.observable();
                self.donorNodes = ko.observableArray();
                self.donorNodesForSelect = ko.computed(function() { return self.nodesToSelect(self.donorNodes, self.selectedDonorProperty(), '#donorSelect'); });
                self.selectedDonors = ko.observableArray();
                self.sampleProperties = ko.observableArray();
                self.selectedSampleProperty = ko.observable();
                self.sampleNodes = ko.observableArray();
                self.sampleNodesForSelect = ko.computed(function() { return self.nodesToSelect(self.sampleNodes, self.selectedSampleProperty(), '#sampleSelect'); });
                self.selectedSamples = ko.observableArray();
                
                // view mode vars
                self.selectedViewLabel = ko.observable();
                self.viewNodes = ko.observableArray();
                self.showAllGraphs = ko.observable(false);
                self.showAllStats = ko.observable(false);
                self.setAllQCGrindQCStatus = ko.observable('unset');
                
                // lanelets can be sorted and filtered
                self.laneletFilters = {
                    passed: ko.observable(true),
                    failed: ko.observable(true),
                    investigate: ko.observable(true),
                    gt_pending: ko.observable(true),
                    pending: ko.observable(true),
                    study_id: ko.observable(undefined),
                    study_name: ko.observable(undefined),
                    study_acc: ko.observable(undefined),
                    individual: ko.observable(undefined),
                    sample: ko.observable(undefined),
                    sample_acc: ko.observable(undefined),
                    sample_sn: ko.observable(undefined),
                    library: ko.observable(undefined),
                    lanelet: ko.observable(undefined),
                    gender: ko.observable(undefined),
                    genotype: ko.observable('all'),
                    verify_bam_id: ko.observable('all'),
                    npg_status: ko.observable('all'),
                    auto_qc: ko.observable('all'),
                    raw_gb: ko.observable(undefined),
                    mapped_gb: ko.observable(undefined),
                    dup_percent: ko.observable(undefined),
                    mapped_dups_gb: ko.observable(undefined),
                    overlap_dup_percent: ko.observable(undefined),
                    net_gb: ko.observable(undefined),
                    depth: ko.observable(undefined),
                    error_rate: ko.observable(undefined)
                };
                self.filteredNodes = ko.observableArray();
                self.maxRows = ko.observable(500);
                self.filteredNodes.extend({
                    progressivefilter: {
                        batchSize: 30,
                        maxRows: self.maxRows,
                        filterFunction: function isItemFiltered(l) {
                            var pass = 
                                (self.laneletFilters.passed() ? 1 : !l.Pass) &&
                                (self.laneletFilters.failed() ? 1 : !l.Fail) &&
                                (self.laneletFilters.investigate() ? 1 : !l.Invst) &&
                                (self.laneletFilters.gt_pending() ? 1 : !l.GTPend) &&
                                (self.laneletFilters.pending() ? 1 : !l.Pend) &&
                                (self.laneletFilters.study_id() ? l.study_id.indexOf(self.laneletFilters.study_id()) !== -1 : 1) &&
                                (self.laneletFilters.study_name() ? l.study_name.toLowerCase().indexOf(self.laneletFilters.study_name().toLowerCase()) !== -1 : 1) &&
                                (self.laneletFilters.study_acc() ? l.study_acc.toLowerCase().indexOf(self.laneletFilters.study_acc().toLowerCase()) !== -1 : 1) &&
                                (self.laneletFilters.individual() ? l.Individual.toLowerCase().indexOf(self.laneletFilters.individual().toLowerCase()) !== -1 : 1) &&
                                (self.laneletFilters.sample() ? l.Sample.toLowerCase().indexOf(self.laneletFilters.sample().toLowerCase()) !== -1 : 1) &&
                                (self.laneletFilters.sample_acc() ? l.sample_acc.toLowerCase().indexOf(self.laneletFilters.sample_acc().toLowerCase()) !== -1 : 1) &&
                                (self.laneletFilters.sample_sn() ? l.sample_sn.toLowerCase().indexOf(self.laneletFilters.sample_sn().toLowerCase()) !== -1 : 1) &&
                                (self.laneletFilters.library() ? (typeof l.Library == 'string' ? (l.Library.indexOf(self.laneletFilters.library()) !== -1) : (l.Library == self.laneletFilters.library())) : 1) &&
                                (self.laneletFilters.lanelet() ? (typeof l.Lanelet == 'string' ? (l.Lanelet.indexOf(self.laneletFilters.lanelet()) !== -1) : (l.Lanelet == self.laneletFilters.lanelet())) : 1) &&
                                (self.laneletFilters.gender() ? l.Gender.toLowerCase().indexOf(self.laneletFilters.gender().toLowerCase()) !== -1 : 1) &&
                                (self.laneletFilters.genotype() === 'all' ? 1 : l.Genotype.startsWith(self.laneletFilters.genotype())) &&
                                (self.laneletFilters.verify_bam_id() === 'all' ? 1 : l['Verify Bam ID'].startsWith(self.laneletFilters.verify_bam_id())) &&
                                (self.laneletFilters.npg_status() === 'all' ? 1 : l['NPG Status'] === self.laneletFilters.npg_status()) &&
                                (self.laneletFilters.auto_qc() === 'all' ? 1 : l.auto_qc()[0] === self.laneletFilters.auto_qc()) &&
                                (self.laneletFilters.raw_gb() ? parseFloat(l['Raw Gb']) >= parseFloat(self.laneletFilters.raw_gb()) : 1) &&
                                (self.laneletFilters.mapped_gb() ? parseFloat(l['Mapped Gb']) >= parseFloat(self.laneletFilters.mapped_gb()) : 1) &&
                                (self.laneletFilters.dup_percent() ? parseFloat(l['Dup%']) <= parseFloat(self.laneletFilters.dup_percent()) : 1) &&
                                (self.laneletFilters.mapped_dups_gb() ? parseFloat(l['Mapped-dups Gb']) >= parseFloat(self.laneletFilters.mapped_dups_gb()) : 1) &&
                                (self.laneletFilters.overlap_dup_percent() ? parseFloat(l['Overlap dup%']) <= parseFloat(self.laneletFilters.overlap_dup_percent()) : 1) &&
                                (self.laneletFilters.net_gb() ? parseFloat(l['Net Gb']) >= parseFloat(self.laneletFilters.net_gb()) : 1) &&
                                (self.laneletFilters.depth() ? parseFloat(l['Depth']) >= parseFloat(self.laneletFilters.depth()) : 1) &&
                                (self.laneletFilters.error_rate() ? parseFloat(l['Error Rate']) >= parseFloat(self.laneletFilters.error_rate()) : 1);
                            return pass;
                        } 
                    }
                });
                self.updateFilter = function() {
                    if (self.selectedViewLabel.peek() != 'Donor') {
                        self.setAllQCGrindQCStatus('unset');
                        self.filteredNodes.filterProgressive(self.viewNodes.peek());
                    }
                };
                self.viewNodes.subscribe(function () {
                    self.updateFilter();
                });
                Object.keys(self.laneletFilters).forEach(function (key) { 
                    var filter = self.laneletFilters[key];
                    filter.subscribe(function () {
                        self.updateFilter();
                    });
                });
                self.setFilter = function(filter, value) {
                    self.laneletFilters[filter](value);
                };
                self.showMoreNodes = function() {
                    self.maxRows(self.maxRows() + 500);
                };
                self.showAllNodes = function() {
                    self.maxRows(self.viewNodes().length);
                };
                self.maxRows.subscribe(function () {
                    if (self.selectedViewLabel.peek() != 'Donor') {
                        self.filteredNodes.filterProgressive(self.viewNodes.peek(), true);
                    }
                });
                
                // configure the multiselects
                $('#groupSelect').multiselect({
                    enableCaseInsensitiveFiltering: true,
                    maxHeight: 300,
                    nonSelectedText: 'Group...'
                });
                $('#studyPropertySelect').multiselect({
                    maxHeight: 300,
                    nonSelectedText: 'Property...'
                });
                $('#studySelect').multiselect({
                    includeSelectAllOption: true,
                    includeSelectAllIfMoreThan: 1,
                    enableCaseInsensitiveFiltering: true,
                    disableIfEmpty: true,
                    maxHeight: 300,
                    nonSelectedText: 'Study...'
                });
                $('#donorPropertySelect').multiselect({
                    maxHeight: 300,
                    nonSelectedText: 'Property...'
                });
                $('#donorSelect').multiselect({
                    includeSelectAllOption: true,
                    includeSelectAllIfMoreThan: 1,
                    enableCaseInsensitiveFiltering: true,
                    disableIfEmpty: true,
                    maxHeight: 300,
                    nonSelectedText: 'Donor...'
                });
                $('#samplePropertySelect').multiselect({
                    maxHeight: 300,
                    nonSelectedText: 'Property...'
                });
                $('#sampleSelect').multiselect({
                    includeSelectAllOption: true,
                    includeSelectAllIfMoreThan: 1,
                    enableCaseInsensitiveFiltering: true,
                    disableIfEmpty: true,
                    maxHeight: 300,
                    nonSelectedText: 'Sample...'
                });
                $('#viewSelect').multiselect({
                    maxHeight: 300,
                    nonSelectedText: 'View...'
                });
                
                // function to unset a selection
                self.deselect = function(selected, id) {
                    if (selected()) {
                        $(id).multiselect('deselect', selected());
                        selected(undefined);
                    }
                };
                
                // function to reset parts of the view
                self.reset = function(mode) {
                    self.viewNodes.removeAll();
                    self.deselect(self.selectedViewLabel, '#viewSelect');
                    
                    if (mode > 1) {
                        self.deselect(self.selectedSampleProperty, '#samplePropertySelect');
                        self.selectedSamples.removeAll();
                        self.sampleNodes.removeAll();
                    }
                    
                    if (mode > 2) {
                        self.deselect(self.selectedDonorProperty, '#donorPropertySelect');
                        self.selectedDonors.removeAll();
                        self.donorNodes.removeAll();
                    }
                    
                    if (mode > 3) {
                        self.deselect(self.selectedStudyProperty, '#studyPropertySelect');
                        self.selectedStudies.removeAll();
                        self.studyNodes.removeAll();
                    }
                };
                
                // get admin details (ignore errors from it to avoid having 2
                // not-logged-in errors)
                self.errorsIgnored = ko.observableArray();
                getQCGraphData('qc_website_admin', { }, { adminUsers: self.adminUsers, groupAdmins: self.groupAdmins, groupConfig: self.groupConfig }, self.loading, self.errorsIgnored);
                
                // when admin-stuff changes, update the graph db
                self.adminUsers.subscribe(function(newValue) {
                    if (newValue && newValue != '') {
                        getQCGraphData('qc_website_admin', { admins: newValue }, { adminUsers: self.adminUsers }, self.loading, self.errors);
                    }
                });
                self.updateGroupAdmins = function(data) {
                    getQCGraphData('qc_website_admin', { group: data.group, group_admins: data.users }, { groupAdmins: self.groupAdmins }, self.loading, self.errors);
                };
                self.updateGroupConfig = function(data) {
                    getQCGraphData('qc_website_admin', { group: data.group, group_qc_fail_reasons: data.qc_fail_reasons }, { groupConfig: self.groupConfig }, self.loading, self.errors);
                };
                
                // get all the schema details from the db
                getQCGraphData('labels', { }, { resultStore: self.labels, labelProperties: self.labelProperties, viewLabels: self.viewLabels, groupNodes: self.groupNodes, studyProperties: self.studyProperties, donorProperties: self.donorProperties, sampleProperties: self.sampleProperties }, self.loading, self.errors);
                
                // when the user selects a study property, if they have also
                // already chosen a group, then fill in the studyPropertyValues
                self.selectedStudyProperty.subscribe(function(newValue) {
                    if (newValue && newValue != '' && self.selectedGroups().length && ! self.studyNodes().length) {
                        getQCGraphData('nodes_of_label', { label: 'Study', groups: self.selectedGroups() }, { resultStore: self.studyNodes }, self.loading, self.errors);
                    }
                });
                
                // when the user changes groups or studies we need to reset things
                self.selectedGroups.subscribe(function() {
                    self.reset(4);
                });
                self.selectedStudies.subscribe(function() {
                    self.reset(3);
                });
                
                // when donor or sample property is changed, fill in the values
                // to select from
                self.selectedDonorProperty.subscribe(function(newValue) {
                    if (newValue && newValue != '' && ! self.donorNodes().length) {
                        getQCGraphData('nodes_of_label', { label: 'Donor', groups: self.selectedGroups(), studies: self.selectedStudies() }, { resultStore: self.donorNodes }, self.loading, self.errors);
                    }
                });
                self.selectedSampleProperty.subscribe(function(newValue) {
                    if (newValue && newValue != '' && ! self.sampleNodes().length) {
                        var opts = {label: 'Sample', groups: self.selectedGroups(), studies: self.selectedStudies()};
                        if (self.selectedDonors().length) {
                            opts.donors = self.selectedDonors();
                        }
                        getQCGraphData('nodes_of_label', opts, { resultStore: self.sampleNodes }, self.loading, self.errors);
                    }
                });
                
                // when donor is changed, update samples
                self.selectedDonors.subscribe(function(newValue) {
                    self.reset(2);
                    
                    if (newValue && newValue != '') {
                        getQCGraphData('nodes_of_label', { label: 'Sample', groups: self.selectedGroups(), studies: self.selectedStudies(), donors: newValue }, { resultStore: self.sampleNodes }, self.loading, self.errors);
                    }
                });
                
                // when samples change, reset the view
                self.selectedSamples.subscribe(function() {
                    self.reset(1);
                });
                
                // for lanelets we need to calculate the auto_qc result when we
                // get the nodes, so first we need to define the settings
                self.autoQCSettings = {
                    'GType regex': { desc: 'A regular expression to choose acceptable genotype status values', value: ko.observable(), default: '^confirmed', size: 10  },
                    'GType min concordance': { desc: 'Minimum concordance found by the genotype check', value: ko.observable(), default: 0.60, size: 2 },
                    'GType min sites': { desc: 'Minimum number of sites with data in the genotype check', value: ko.observable(), default: 15, size: 2 },
                    'Mapped base %': { desc: 'Minimum percentage of mapped bases', value: ko.observable(), default: 90, size: 2 },
                    'Duplicate read %': { desc: 'Maximum percentage of duplicate reads', value: ko.observable(), default: 30, size: 2 },
                    'Mapped reads properly paired %': { desc: 'Minimum percentage of the reads that are mapped which are also properly paired', value: ko.observable(), default: 80, size: 2 },
                    'Error rate': { desc: 'Maximum allowed error rate', value: ko.observable(), default: 0.02, size: 3 },
                    'Max in/del ratio': { desc: 'Maximum insert to deletion ratio', value: ko.observable(), default: 0.97, size: 3 },
                    'Min in/del ratio': { desc: 'Minimum insert to deletion ratio', value: ko.observable(), default: 0.68, size: 3 },
                    'Overlapping Base Duplicate %': { desc: 'Maximum percent of bases duplicated due to overlapping reads of a pair', value: ko.observable(), default: 4, size: 2 },
                    'Max indel/cycle above median': { desc: 'Maximimum indels per cycle, factor above median', value: ko.observable(), default: 8, size: 2 }
                };
                self.autoQCConfigKeys = Object.keys(self.autoQCSettings); // most browsers always return the keys in the above order?
                self.autoQCConfigKeys.forEach(function (key) {
                    // when any of these change we need to update the filter,
                    // but only after all the new auto_qc values have been
                    // calculated, or the filter count and possibly what is
                    // filtered will be wrong. Here we just wait half a second;
                    // I couldn't figure out a nice way of knowing when all the
                    // computed functions have finished...
                    var setting = self.autoQCSettings[key].value;
                    setting.subscribe(function () {
                        self.updateFilter(); // immediate results
                        setTimeout(self.updateFilter, 500); // correct the count
                    });
                });
                self.getCurrentAutoQCSettings = function() {
                    var currentSettings = {};
                    self.autoQCConfigKeys.forEach(function (key) {
                        currentSettings[key] = self.autoQCSettings[key].value();
                    });
                    return currentSettings;
                };
                self.setUserAutoQCSettings = function(setDefault) {
                    var name = 'auto_qc_settings';
                    if (! setDefault) {
                        name += location.hash;
                    }
                    Cookies.set(name, self.getCurrentAutoQCSettings(), { secure: true, expires: 365 });
                    return true;
                };
                self.aqcSelectionButtonClass = ko.observable('btn-secondary');
                self.aqcStudyButtonClass = ko.observable('btn-secondary');
                self.aqcDefaultButtonClass = ko.observable('btn-secondary');
                self.setStudyAutoQCSettings = function() {
                    var currentSettings = self.getCurrentAutoQCSettings();
                    currentSettings = JSON.stringify(currentSettings);
                    ko.utils.arrayForEach(self.selectedStudies(), function(studyNodeID) {
                        vrpipeRestMethod('qc', 'set_study_auto_qc_settings', { study: studyNodeID, settings: currentSettings }, self.loading, self.errors, function(data) {
                            if (data.success) {
                                // flash the button to confirm
                                var $button = $('#aqc_study_button');
                                $button.fadeOut(100, function(){ $button.removeClass(self.aqcStudyButtonClass()); $button.addClass('btn-success'); $button.fadeIn(500, function(){ $button.removeClass('btn-success'); $button.addClass(self.aqcStudyButtonClass()); }) });
                            }
                        });
                    });
                    return true;
                };
                self.initialAutoQCSettings = {};
                self.revertAutoQCSettings = function() {
                    self.autoQCConfigKeys.forEach(function (key) {
                        self.autoQCSettings[key].value(self.initialAutoQCSettings[key]);
                    });
                };
                
                // when the user selects a view, get all nodes with that label,
                // filtered based on group, studies and any other selections.
                self.selectedViewLabel.subscribe(function(newValue) {
                    if (newValue && newValue != '' && self.selectedGroups().length && self.selectedStudies().length) {
                        self.viewNodes.removeAll();
                        var loc = '/groups:' + self.selectedGroups() + '/studies:' + self.selectedStudies();
                        var opts = {label: newValue[0], table_mode: true, groups: self.selectedGroups(), studies: self.selectedStudies()};
                        if (self.selectedDonors().length) {
                            opts.donors = self.selectedDonors();
                            loc = loc + '/donors:' + self.selectedDonors();
                        }
                        else {
                            loc = loc + '/donors:all';
                        }
                        if (self.selectedSamples().length) {
                            opts.samples = self.selectedSamples();
                            loc = loc + '/samples:' + self.selectedSamples();
                        }
                        else {
                            loc = loc + '/samples:all';
                        }
                        
                        if (newValue == 'Lanelet') {
                            // set autoQCSettings values based on what user has
                            // saved in their cookie, on the study or the
                            // default. cookie selection > study > cookie
                            // default > code default. We'll change the button
                            // class to indicate to the user which settings are
                            // being used.
                            var savedSettings = Cookies.getJSON('auto_qc_settings' + location.hash);
                            
                            if (savedSettings) {
                                self.aqcSelectionButtonClass('btn-info');
                            }
                            else {
                                var currentStudyNodeIds = {};
                                ko.utils.arrayForEach(self.selectedStudies(), function(studyNodeID) {
                                    currentStudyNodeIds[studyNodeID] = 1;
                                });
                                ko.utils.arrayForEach(self.studyNodes(), function(node) {
                                    // if multiple studies have conflicting settings
                                    // we're just going to go with the first we see
                                    if (!savedSettings && currentStudyNodeIds[node.id]) {
                                        var theseSettings = node.properties.auto_qc_settings;
                                        if (theseSettings) {
                                            savedSettings = JSON.parse(theseSettings);
                                            self.aqcStudyButtonClass('btn-info');
                                        }
                                    }
                                });
                            }
                            
                            if (!savedSettings) {
                                savedSettings = Cookies.getJSON('auto_qc_settings');
                                if (savedSettings) {
                                    self.aqcDefaultButtonClass('btn-info');
                                }
                                else {
                                    savedSettings = {};
                                }
                            }
                            
                            self.autoQCConfigKeys.forEach(function (key) {
                                self.autoQCSettings[key].value(savedSettings.hasOwnProperty(key) ? savedSettings[key] : self.autoQCSettings[key].default);
                            });
                            
                            self.initialAutoQCSettings = self.getCurrentAutoQCSettings();
                        }
                        
                        self.maxRows(500);
                        getQCGraphData('nodes_of_label', opts, { resultStore: self.viewNodes, isGroupAdmin: self.isGroupAdmin, autoQCSettings: self.autoQCSettings, flatten: true }, self.loading, self.errors);
                        
                        // and set the browser url to make this selection
                        // bookmarkable and included in the history
                        loc = loc + '/view:' + newValue;
                        if (location.hash !== '#' + loc) {
                            location.hash = loc;
                        }
                    }
                });
                
                // client-side route which fills in the selection dropdowns
                // based on the user changing the url in the browser directly
                // (to enable bookmarkability and history)
                var route = router.addRoute('/groups\::groups/studies\::studies/donors\::donors/samples\::samples/view\::view');
                route.get(function(event, params) {
                    var groups = splitToInts(params.groups);
                    var studies = splitToInts(params.studies);
                    var donors = params.donors === 'all' ? [] : splitToInts(params.donors);
                    var samples = params.samples === 'all' ? [] : splitToInts(params.samples);
                    if (! arraysEqual(groups, self.selectedGroups()) || ! arraysEqual(studies, self.selectedStudies()) || ! arraysEqual(donors, self.selectedDonors()) || ! arraysEqual(samples, self.selectedSamples()) || params.view != self.selectedViewLabel()) {
                        self.reset(4);
                        
                        // simulate selecting the desired things from the
                        // selects, waiting each time for the selects to
                        // populate
                        runWhenPopulated(self.groupNodes, function() {
                            self.selectedGroups(groups);
                            self.selectedStudyProperty(['name']);
                            $('#studyPropertySelect').multiselect('select', self.selectedStudyProperty());
                            
                            runWhenPopulated(self.studyNodes, function() {
                                self.selectedStudies(studies);
                                
                                if (donors.length) {
                                    self.selectedDonorProperty(['example_sample']);
                                    $('#donorPropertySelect').multiselect('select', self.selectedDonorProperty());
                                    
                                    runWhenPopulated(self.donorNodes, function() {
                                        self.selectedDonors(donors);
                                        
                                        if (samples.length) {
                                            self.selectedSampleProperty(['name']);
                                            $('#samplePropertySelect').multiselect('select', self.selectedSampleProperty());
                                            
                                            runWhenPopulated(self.sampleNodes, function() {
                                                self.selectedSamples(samples);
                                                self.selectedViewLabel([params.view]);
                                                $('#viewSelect').multiselect('select', self.selectedViewLabel());
                                            });
                                        }
                                        else {
                                            self.selectedViewLabel([params.view]);
                                            $('#viewSelect').multiselect('select', self.selectedViewLabel());
                                        }
                                    });
                                }
                                else if (samples.length) {
                                    self.selectedSampleProperty(['name']);
                                    $('#samplePropertySelect').multiselect('select', self.selectedSampleProperty());
                                    
                                    runWhenPopulated(self.sampleNodes, function() {
                                        self.selectedSamples(samples);
                                        self.selectedViewLabel([params.view]);
                                        $('#viewSelect').multiselect('select', self.selectedViewLabel());
                                    });
                                }
                                else {
                                    self.selectedViewLabel([params.view]);
                                    $('#viewSelect').multiselect('select', self.selectedViewLabel());
                                }
                            });
                        });
                    }
                });
                
                // dynamic view table columns
                self.columns = ko.observable({});
                self.numColumns = ko.observable(0);
                self.numQCColumns = ko.observable(0);
                self.previousViewLabel = null;
                self.sampleExcludedColumns = ko.observable({});
                self.viewColumns = ko.computed(function () {
                    var columns = [];
                    
                    if (self.selectedViewLabel() != null && (self.previousViewLabel === null || self.previousViewLabel != self.selectedViewLabel())) {
                        var details = {};
                        var excluded = {};
                        var n = 0;
                        var nqc = 0;
                        var i;
                        var col;
                        var len;
                        
                        // read user cookie to see if they have chosen columns
                        // saved for this url or as their own default
                        var userCols = Cookies.getJSON('columns' + location.hash);
                        if (!userCols) {
                            userCols = Cookies.getJSON('columns');
                        }
                        var desiredCols = {};
                        if (userCols) {
                            var uclen = userCols.length;
                            for (i = 0; i < uclen; i += 1) {
                                desiredCols[userCols[i]] = 1;
                            }
                        }
                        
                        if (self.selectedViewLabel() == 'Donor') {
                            var colNames = ["ID", "Example Sample", "Sample Creation Date", "QCToDo(Fluidigm)", "QCToDo(Genotyping)", "QCToDo(All)"];
                            len = colNames.length;
                            for (i = 0; i < len; i += 1) {
                                col = { header: colNames[i], text: colNames[i], sortOn: colNames[i], display: ko.observable(true), desc: '', isqc: false };
                                details[colNames[i]] = col;
                                columns.push(col);
                                n += 1;
                            }
                        }
                        else if (self.selectedViewLabel() == 'Lanelet' || self.selectedViewLabel() == 'Sample') {
                            var cols = [
                                ["Pass", "Pass", "Pass", true, '', true],
                                ["Fail", "Fail", "Fail", true, '', true],
                                ["Invst", "Invst", "Invst", true, '', true],
                                ["GTPend", "GTPend", "GTPend", false, '', true],
                                ["Pend", "Pend", "Pend", true, '', true],
                                ["Study ID", "study_id", "study_id", false],
                                ["Study Name", "study_name", "study_name", false],
                                ["Study Acc", "study_acc", "study_acc", false],
                                ["Individual", "Individual", "Individual", false],
                                ["Sample", "Sample", "Sample", true],
                                ["Sample Acc", "sample_acc", "sample_acc", false],
                                ["Sample Suppl", "sample_sn", "sample_sn", false, "sample supplier name"],
                                ["Library", "Library", "Library", true],
                                ["Lanelet", "Lanelet", "Lanelet", true],
                                ["Gender", "Gender", "Gender", false],
                                ["Genotype", "Genotype", "gtcheckdata:concordance", true],
                                ["Verify Bam ID", "Verify Bam ID", "verifybamiddata:freemix", true],
                                ["NPG Status", "NPG Status", "NPG Status", true],
                                ["Auto QC", "auto_qc", "auto_qc()", true],
                                ["Raw Gb", "Raw Gb", "Raw Gb", true],
                                ["Mapped Gb", "Mapped Gb", "Mapped Gb", true, "mapped Gb (cigar)"],
                                ["Dup%", "Dup%", "Dup%", true, "percent of mapped reads which were duplicates"],
                                ["Mapped-dups Gb", "Mapped-dups Gb", "Mapped-dups Gb", true, "Gb mapped ignoring duplicate reads"],
                                ["Overlap dup%", "Overlap dup%", "Overlap dup%", true, "the percent of bases duplicated due to reads of a pair overlapping"],
                                ["Net Gb", "Net Gb", "Net Gb", true, "Gb excluding overlapping base duplicates"],
                                ["Depth", "Depth", "Depth", false, "bases mapped ignoring duplicate reads / 3000000000"],
                                ["Error Rate%", "Error Rate", "Error Rate", true, "percent of mismatches in bases mapped (cigar)"]
                            ];
                            len = cols.length;
                            
                            var display;
                            for (i = 0; i < len; i += 1) {
                                display = false;
                                if (userCols) {
                                    if (desiredCols.hasOwnProperty(cols[i][0])) {
                                        display = true;
                                    }
                                }
                                else {
                                    display = cols[i][3];
                                }
                                
                                col = { header: cols[i][0], text: cols[i][1], sortOn: cols[i][2], display: ko.observable(display), desc: cols[i][4], isqc: cols[i][5] };
                                details[cols[i][0]] = col;
                                columns.push(col);
                                
                                if (self.selectedViewLabel() == 'Sample' && (i >= 15 && i <= 18)) {
                                    excluded[cols[i][0]] = 1;
                                    continue;
                                }
                                
                                if (display) {
                                    n += 1;
                                    if (i <= 4) {
                                        nqc += 1;
                                    }
                                }
                            }
                        }
                        else {
                            var obj = self.viewNodes()[0];
                            Object.keys(obj).forEach(function (name) {
                                if (name === 'node_id' || name === 'node_label') {
                                    return;
                                }
                                col = { header: name, text: name, sortOn: name, display: ko.observable(true), desc: '', isqc: false };
                                details[name] = col;
                                columns.push(col);
                                n += 1;
                            });
                        }
                        
                        self.columns(details);
                        self.sampleExcludedColumns(excluded);
                        self.numColumns(n);
                        self.numQCColumns(nqc);
                        self.previousViewLabel = self.selectedViewLabel();
                    }
                    
                    return columns;
                });
                self.toggleColumn = function (column, event) {
                    if (event.target.nodeName === "INPUT") {
                        if (column.display()) {
                            self.numColumns(self.numColumns() + 1);
                            if (column.isqc) {
                                self.numQCColumns(self.numQCColumns() + 1);
                            }
                        }
                        else {
                            self.numColumns(self.numColumns() - 1);
                            if (column.isqc) {
                                self.numQCColumns(self.numQCColumns() - 1);
                            }
                        }
                        return true;
                    }
                    else {
                        column.display(! column.display());
                        if (column.display()) {
                            self.numColumns(self.numColumns() + 1);
                            if (column.isqc) {
                                self.numQCColumns(self.numQCColumns() + 1);
                            }
                        }
                        else {
                            self.numColumns(self.numColumns() - 1);
                            if (column.isqc) {
                                self.numQCColumns(self.numQCColumns() - 1);
                            }
                        }
                    }
                    return false;
                };
                
                // column choice can be saved to the user's cookie
                self.rememberColumns = function(setDefault) {
                    var name = 'columns';
                    if (! setDefault) {
                        // setting Cookie path: '' doesn't work, since our
                        // real path is just /pages; we want a cookie specific
                        // to our fake path, so we append our fake path to
                        // the cookie name instead
                        name += location.hash;
                    }
                    
                    var cols = [];
                    var i;
                    var clen = self.viewColumns().length;
                    var col;
                    for (i = 0; i < clen; i += 1) {
                        col = self.viewColumns()[i];
                        if (col.display()) {
                            cols.push(col.header);
                        }
                    }
                    
                    Cookies.set(name, cols, { secure: true, expires: 365 });
                };
                
                // when a node in the view table is clicked on, open a new tab
                // with the results
                self.showQCForNode = function(node) {
                    var nodeID = +node.node_id;
                    var nodeLabel = node.node_label;
                    
                    if (nodeLabel === 'Donor') {
                        window.open('/pages/vrtrack_qc/donor.html?id=' + nodeID, '_blank', '', false);
                    }
                    
                    return true;
                };
                
                // when a lanelet qc status is changed, set in db and update
                // the booleans that enable column sorting
                self.qcStatusToCol = {passed: 'Pass', failed: 'Fail', investigate: 'Invst', 'gt_pending': 'GTPend', pending: 'Pend'};
                self.changeQCStatus = function(laneletStatus, lanelet) {
                    var oldStatus = lanelet.qcgrind_qc_status;
                    var unique = lanelet.Lanelet;
                    
                    vrpipeRestMethod('qc', 'set_lanelet_qc_status', { lane: unique, status: laneletStatus }, self.loading, self.errors, function(data) {
                        if (data.success) {
                            lanelet.qcgrind_qc_status = laneletStatus;
                            lanelet[self.qcStatusToCol[oldStatus]] = 0;
                            lanelet[self.qcStatusToCol[laneletStatus]] = 1;
                            
                            // also colour the radio as indication of what has
                            // been set this session
                            var id = unique + '_' + oldStatus;
                            var radioDiv = document.getElementById(id);
                            radioDiv.style.backgroundColor = 'transparent';
                            id = unique + '_' + laneletStatus;
                            radioDiv = document.getElementById(id);
                            radioDiv.style.backgroundColor = 'yellow';
                        }
                    });
                    
                    return true;
                };
                
                // we have a single button that can change the qc status on
                // all the filtered lanes in one go
                self.setAllQCGrindQC = function() {
                    var newStatus = self.setAllQCGrindQCStatus();
                    ko.utils.arrayForEach(self.filteredNodes(), function(lanelet) {
                        if (lanelet.new_qcgrind_qc_status() != newStatus) {
                            self.changeQCStatus(newStatus, lanelet);
                            lanelet.new_qcgrind_qc_status(newStatus);
                        }
                    });
                };
                
                // lanelet view has various popups for different columns
                self.genotypePopover = function(lane) {
                    if (lane.hasOwnProperty('gtcheckdata:reception_call_string') && lane['gtcheckdata:reception_call_string']) {
                        var matchCount = lane['gtcheckdata:match_count'] || 0;
                        var commonCount = lane['gtcheckdata:common_snp_count'] || 0;
                        var html = '<table class="table table-bordered table-striped table-condensed small" style="margin-bottom: 0"><caption>' + matchCount + '/' + commonCount + ' (' + lane['gtcheckdata:match_percent'] + '%) matched to ' + lane['gtcheckdata:matched_sample_name'] + '</caption><tbody>';
                        
                        html += '<tr><th>Reception calls</th>';
                        var rCalls = lane['gtcheckdata:reception_call_string'];
                        var rCallsArray = [];
                        var i;
                        var rCallsLength = rCalls.length;
                        var call;
                        for (i = 0; i < rCallsLength; i += 2) {
                            call = rCalls.substring(i, i + 2);
                            html += '<td>' + call + '</td>';
                            rCallsArray.push(call);
                        }
                        html += '</tr>';
                        
                        if (lane['gtcheckdata:match_score']) {
                            var scores = lane['gtcheckdata:match_score'].split(';');
                            
                            html += '<tr><th>BAM calls</th>';
                            var bCalls = lane['gtcheckdata:bam_call_string'];
                            var depths = lane['gtcheckdata:bam_gt_depths_string'].split(';');
                            var bCallsLength = bCalls.length;
                            var rCall;
                            var bootstrapClass;
                            var callsI = 0;
                            for (i = 0; i < bCallsLength; i += 2) {
                                call = bCalls.substring(i, i + 2);
                                if (call === 'NN') {
                                    call = '--';
                                }
                                rCall = rCallsArray[callsI];
                                bootstrapClass = '';
                                if (rCall !== '--' && call !== '--') {
                                    if (scores[callsI] === '1') {
                                        bootstrapClass = 'success';
                                    }
                                    else if (scores[callsI] === '-1' || depths[callsI] >= 4) {
                                        bootstrapClass = 'danger';
                                    }
                                    else {
                                        bootstrapClass = 'warning';
                                    }
                                }
                                
                                html += '<td class="' + bootstrapClass + '">' + call + '</td>';
                                callsI += 1;
                            }
                            html += '</tr>';
                            
                            html += '<tr><th>Call depths</th>';
                            var depthsLength = depths.length;
                            for (i = 0; i < depthsLength; i += 1) {
                                html += '<td>' + depths[i] + '</td>';
                            }
                            html += '</tr>';
                        }
                        
                        html += '</tbody></table>';
                        return html;
                    }
                    else {
                        return '<p>no genotype result details available</p>';
                    }
                };
                self.verifyPopover = function(lane) {
                    var html = '<table class="table table-bordered table-striped table-condensed small" style="margin-bottom: 0"><tbody>';
                    
                    html += '<tr><th>Number of SNPs</th><td>' + lane['verifybamiddata:number_of_snps'] + '</td></tr>';
                    html += '<tr><th>Average Depth</th><td>' + lane['verifybamiddata:avg_depth'] + '</td></tr>';
                    html += '<tr><th>Freemix</th><td>' + lane['verifybamiddata:freemix'] + '</td></tr>';
                    html += '<tr><th>FreeLK0</th><td>' + lane['verifybamiddata:freeLK0'] + '</td></tr>';
                    html += '<tr><th>FreeLK1</th><td>' + lane['verifybamiddata:freeLK1'] + '</td></tr>';
                    
                    html += '</tbody></table>';
                    return html;
                };
                self.autoQCPopover = function(lane) {
                    var html = '<table class="table table-bordered table-striped table-condensed small" style="margin-bottom: 0"><tbody>';
                    
                    ko.utils.arrayForEach(lane.auto_qc()[1], function(reason) {
                        html += '<tr><th>' + reason[0] + '</th><td>' + reason[1] + '</td></tr>';
                    });
                    
                    html += '</tbody></table>';
                    return html;
                };
                
                self.toggleLaneletGraphs = function (node) {
                    node.display_graphs(!node.display_graphs());
                };
                $(document).on('click', '.img-row-img', function() { // can't get focus and blur to work in firefox
                    $(this).parent().css({
                        'flex-grow' : $(this).parent().css('flex-grow') === '4' ? '1' : '4'
                    });
                });
                self.toggleLaneletStats = function (node) {
                    node.display_stats(!node.display_stats());
                };
                self.showAllGraphs.subscribe(function(newValue) {
                    ko.utils.arrayForEach(self.viewNodes(), function(node) {
                        node.display_graphs(newValue);
                    });
                });
                self.showAllStats.subscribe(function(newValue) {
                    ko.utils.arrayForEach(self.viewNodes(), function(node) {
                        node.display_stats(newValue);
                    });
                });
                self.toggleLanelets = function (node) {
                    node.display_lanelets(!node.display_lanelets());
                };
            }
            
            var qcvm = new QCViewModel();
            ko.applyBindings(qcvm, $('#qc')[0]);
            
            router.start('/');
        </script>
    </body>
</html>
