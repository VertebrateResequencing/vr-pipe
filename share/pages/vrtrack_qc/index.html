<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>VRTrack QC</title>
        
        <!-- jQuery for REST interaction, and needed by bootstrap.js -->
        <script src="/js/jquery-1.12.0.min.js"></script>
        
        <!-- Bootstrap for presentation and styling -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/css/bootstrap-3.3.4.min.css">
        <script src="/js/bootstrap-3.3.4.min.js"></script>
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
          <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
        
        <!-- Knockout for event handling -->
        <script src="/js/knockout-3.4.0.min.js"></script>
        <script src="/js/knockout-switch-case.min.js"></script>
        <script src="/js/knockout-projections-1.1.0.min.js"></script>
        <script src="/js/knockstrap-1.3.1.min.js"></script>
        
        <!-- Bootstrap Multiselect for nice selects -->
        <script src="/js/bootstrap-multiselect-0.9.8.min.js"></script>
        <link rel="stylesheet" href="/css/bootstrap-multiselect-0.9.8.css">
        
        <!-- Simrou for client-side navigation -->
        <script src="/js/simrou-1.5.4.min.js"></script>
        
        <!-- Some of our own general helper functions -->
        <script src="/js/vrpipe.js"></script>
        <link rel="stylesheet" href="/css/vrpipe.css">
        
        <!-- vrtrack_qc functions -->
        <script src="/pages/vrtrack_qc/qc.js"></script>
    </head>
    <body>
        <div id="nav" class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <span class="navbar-brand">VRTrack QC</span>
                </div>
                
                <script type="text/html" src="/login_template.html" id="login-template"></script>
                <div data-bind="template: { name: 'login-template' }"></div>
            </div>
        </div>
        
        <div class="container-fluid">
            <div id="qc">
                <div data-bind="loadingWhen: loading().length">
                    &nbsp;
                </div>
                
                <p style="margin-bottom: 20px" data-bind="visible: groupConfig().length || adminUsers">administration <span data-bind="text: adminToggle, click: toggleAdmin" style="cursor: pointer"></span></p>
                <div id="admintoggle" class="well" data-bind="visible: adminToggle() == '<<<-'">
                    <div id="admin" data-bind="visible: adminUsers" class="panel panel-default">
                        <div class="panel-body">
                            <form class="panel panel-default">
                                <div class="input-group panel-body">
                                    <span class="input-group-addon" data-toggle="tooltip" data-container="body" title="Enter one or more space or comma separated unix usernames to set who can administer the QC website.">admin(s)</span>
                                    <input type="text" class="form-control" data-bind="value: adminUsers">
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" type="submit"><span class="glyphicon glyphicon-play-circle"></span></button>
                                    </span>
                                </div>
                            </form>
                                
                            <div id="groupadmins" data-bind="visible: groupAdmins().length" class="panel panel-default">
                                <div class="panel-heading">Group Admins</div>
                                <div class="panel-body">
                                    <div data-bind="foreach: groupAdmins">
                                        <form data-bind="submit: function(formElement) { formElement.find('button[type=submit]').trigger('click'); }">
                                            <div class="input-group">
                                                <span class="input-group-addon" data-toggle="tooltip" data-container="body" title="Enter one or more space or comma separated unix usernames to set who can administer this group." data-bind="text: group"></span>
                                                <input type="text" class="form-control" data-bind="value: users">
                                                <span class="input-group-btn">
                                                    <button class="btn btn-default" type="submit" data-bind="click: $parent.updateGroupAdmins"><span class="glyphicon glyphicon-play-circle"></span></button>
                                                </span>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="groupconfig" data-bind="visible: groupConfig().length" class="panel panel-default">
                        <div class="panel-heading">Group QC Failure Reasons</div>
                        <div class="panel-body">
                            <div data-bind="foreach: groupConfig">
                                <form data-bind="submit: function(formElement) { formElement.find('button[type=submit]').trigger('click'); }">
                                    <div class="input-group">
                                        <span class="input-group-addon" data-toggle="tooltip" data-container="body" title="Enter one or more comma separated possible reasons for QC failure of samples in this group." data-bind="text: group"></span>
                                        <input type="text" class="form-control" data-bind="value: qc_fail_reasons">
                                        <span class="input-group-btn">
                                            <button class="btn btn-default" type="submit" data-bind="click: $parent.updateGroupConfig"><span class="glyphicon glyphicon-play-circle"></span></button>
                                        </span>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="selector">
                    <form role="form" class="input-group btn-group">
                        <span class="input-group-addon"><b>Group</b></span>
                        <select size="2" id="groupSelect" class="multiselect" multiple="multiple" data-bind="
                            options: groupNodes,
                            optionsText: function(item) {
                                return item.properties['name']
                            },
                            optionsValue: function(item) {
                                return +item.id
                            },
                            selectedOptions: selectedGroups,
                            multiselect: true">
                        </select>
                    </form>
                    
                    <form role="form" class="input-group btn-group top-margin" data-bind="visible: selectedGroups().length">
                        <span class="input-group-addon"><b>Study</b></span>
                        <select size="2" id="studyPropertySelect" class="multiselect" data-bind="
                            options: studyProperties,
                            selectedOptions: selectedStudyProperty,
                            multiselect: true">
                        </select>
                        <select size="2" id="studySelect" class="multiselect" multiple="multiple" data-bind="
                            options: studyNodesForSelect,
                            optionsText: 'property',
                            optionsValue: function(item) {
                                return +item.id
                            },
                            selectedOptions: selectedStudies,
                            multiselect: true">
                        </select>
                    </form>
                    
                    <div data-bind="visible: selectedStudies().length">
                        <form role="form" class="input-group btn-group top-margin">
                            <span class="input-group-addon">Donor</span>
                            <select size="2" id="donorPropertySelect" class="multiselect" data-bind="
                                options: donorProperties,
                                selectedOptions: selectedDonorProperty,
                                multiselect: true">
                            </select>
                            <select size="2" id="donorSelect" class="multiselect" multiple="multiple" data-bind="
                                options: donorNodesForSelect,
                                optionsText: 'property',
                                optionsValue: function(item) {
                                    return +item.id
                                },
                                selectedOptions: selectedDonors,
                                multiselect: true">
                            </select>
                        </form>
                        
                        <form role="form" class="input-group btn-group top-margin">
                            <span class="input-group-addon">Sample</span>
                            <select size="2" id="samplePropertySelect" class="multiselect" data-bind="
                                options: sampleProperties,
                                selectedOptions: selectedSampleProperty,
                                multiselect: true">
                            </select>
                            <select size="2" id="sampleSelect" class="multiselect" multiple="multiple" data-bind="
                                options: sampleNodesForSelect,
                                optionsText: 'property',
                                optionsValue: function(item) {
                                    return +item.id
                                },
                                selectedOptions: selectedSamples,
                                multiselect: true">
                            </select>
                        </form>
                        
                        <form role="form" class="input-group btn-group top-margin">
                            <span class="input-group-addon"><b>View</b></span>
                            <select size="2" id="viewSelect" class="multiselect" data-bind="
                                options: viewLabels,
                                selectedOptions: selectedViewLabel,
                                multiselect: true">
                            </select>
                        </form>
                    </div>
                </div>
                
                <div class="top-margin" id="errors" data-bind="foreach: errors">
                    <div class="alert alert-danger fade in">
                        <p data-bind="text: $data"></p>
                    </div>
                </div>
                
                <div id="viewtable" data-bind="visible: viewNodes().length">
                    <hr>
                    
                    <!-- ko if: selectedViewLabel() == 'Lanelet' -->
                        <form role="form" style="margin-bottom: 20px">
                            <label class="checkbox-inline">
                                <input type="checkbox" data-bind="checked: showAllGraphs" /> show all graphs
                            </label>
                            <label class="checkbox-inline">
                                <input type="checkbox" data-bind="checked: showAllStats" /> show all stats
                            </label>
                        </form>
                    <!-- /ko -->
                    
                    <div class="panel panel-default">
                        <div class="panel-heading" data-bind="text: selectedViewLabel"></div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-condensed small">
                                <thead>
                                    <tr data-bind="foreach: viewColumnNames">
                                        <th data-bind="sort: { arr: $parent.viewNodes, prop: $data }"><span data-bind="text: $data"></span></th>
                                    </tr>
                                    
                                    <tr style="background-color:#F5F5F5" data-bind="visible: selectedViewLabel() == 'Lanelet'">
                                        <td>
                                            <label class="radio-highlightable"> <!-- just to get the alignment similar to the radios in body column beneath -->
                                                <input type="checkbox" data-bind="checked: laneletFilters['passed']" />
                                            </label>
                                        </td>
                                        <td>
                                            <label class="radio-highlightable">
                                                <input type="checkbox" data-bind="checked: laneletFilters['failed']" />
                                            </label>
                                        </td>
                                        <td>
                                            <label class="radio-highlightable">
                                                <input type="checkbox" data-bind="checked: laneletFilters['investigate']" />
                                            </label>
                                        </td>
                                        <td>
                                            <label class="radio-highlightable">
                                                <input type="checkbox" data-bind="checked: laneletFilters['gt_pending']" />
                                            </label>
                                        </td>
                                        <td>
                                            <label class="radio-highlightable">
                                                <input type="checkbox" data-bind="checked: laneletFilters['pending']" />
                                            </label>
                                        </td>
                                        <td></td>
                                        <td></td>
                                        <td>
                                            <input type="text" size="6" data-bind="textInput: laneletFilters['library']" />
                                        </td>
                                        <td>
                                            <input type="text" size="6" data-bind="textInput: laneletFilters['run']" />
                                        </td>
                                        <td>
                                            <select data-bind="value: laneletFilters['genotype']">
                                                <option value="all">all</option>
                                                <option value="confirmed">confirmed</option>
                                                <option value="unconfirmed">unconfirmed</option>
                                                <option value="unchecked">unchecked</option>
                                                <option value="unknown">unknown</option>
                                                <option value="candidate">candidate</option>
                                                <option value="wrong">wrong</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select data-bind="value: laneletFilters['verify_bam_id']">
                                                <option value="all">all</option>
                                                <option value="pass">pass</option>
                                                <option value="fail">failed</option>
                                                <option value="unknown">unknown</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select data-bind="value: laneletFilters['npg_status']">
                                                <option value="all">all</option>
                                                <option value="pass">pass</option>
                                                <option value="fail">failed</option>
                                                <option value="unknown">unknown</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select data-bind="value: laneletFilters['auto_qc_status']">
                                                <option value="all">all</option>
                                                <option value="passed">passed</option>
                                                <option value="failed">failed</option>
                                                <option value="unknown">unknown</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="text" size="2" data-bind="textInput: laneletFilters['raw_gb']" />
                                        </td>
                                        <td>
                                            <input type="text" size="2" data-bind="textInput: laneletFilters['mapped_gb']" />
                                        </td>
                                        <td>
                                            <input type="text" size="2" data-bind="textInput: laneletFilters['dup_percent']" />
                                        </td>
                                        <td>
                                            <input type="text" size="2" data-bind="textInput: laneletFilters['mapped_dups_gb']" />
                                        </td>
                                        <td>
                                            <input type="text" size="2" data-bind="textInput: laneletFilters['overlap_dup_percent']" />
                                        </td>
                                        <td>
                                            <input type="text" size="2" data-bind="textInput: laneletFilters['net_gb']" />
                                        </td>
                                        <td></td>
                                    </tr>
                                </thead>
                                <!-- ko switch: selectedViewLabel -->
                                    <!-- ko case: 'Lanelet' -->
                                        <!-- for speed we must explicitly specify every column -->
                                        <tbody data-bind="foreach: filteredLanelets">
                                            <tr>
                                                <td class="text-center">
                                                    <div class="radio-highlightable" data-bind="attr: {'id': Run + '_passed'}">
                                                        <input type="radio" value="passed" data-bind="checked: new_qcgrind_qc_status, enable: is_admin, click: $parent.changeQCStatus.bind($data, 'passed')" />
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="radio-highlightable" data-bind="attr: {'id': Run + '_failed'}">
                                                        <input type="radio" value="failed" data-bind="checked: new_qcgrind_qc_status, enable: is_admin, click: $parent.changeQCStatus.bind($data, 'failed')" />
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="radio-highlightable" data-bind="attr: {'id': Run + '_investigate'}">
                                                        <input type="radio" value="investigate" data-bind="checked: new_qcgrind_qc_status, enable: is_admin, click: $parent.changeQCStatus.bind($data, 'investigate')" />
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="radio-highlightable" data-bind="attr: {'id': Run + '_gt_pending'}">
                                                        <input type="radio" value="gt_pending" data-bind="checked: new_qcgrind_qc_status, enable: is_admin, click: $parent.changeQCStatus.bind($data, 'gt_pending')" />
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="radio-highlightable" data-bind="attr: {'id': Run + '_pending'}">
                                                        <input type="radio" value="pending" data-bind="checked: new_qcgrind_qc_status, enable: is_admin, click: $parent.changeQCStatus.bind($data, 'pending')" />
                                                    </div>
                                                </td>
                                                <td data-bind="text: Individual"></td>
                                                <td data-bind="text: Sample"></td>
                                                <td data-bind="text: Library"></td>
                                                <td data-bind="text: Run"></td>
                                                <td>
                                                    <span style="cursor: pointer" data-bind="text: Genotype, popover: { content: $parent.genotypePopover($data), container: 'body', html: true, placement: 'top' }"></span>
                                                </td>
                                                <td>
                                                    <span style="cursor: pointer" data-bind="text: $data['Verify Bam ID'], popover: { content: $parent.verifyPopover($data), container: 'body', html: true, placement: 'top' }"></span>
                                                </td>
                                                <td data-bind="text: $data['NPG Status']"></td>
                                                <td data-bind="text: $data['Auto QC Status']"></td>
                                                <td data-bind="text: $data['Raw Gb']"></td>
                                                <td data-bind="text: $data['Mapped Gb']"></td>
                                                <td data-bind="text: $data['Dup%']"></td>
                                                <td data-bind="text: $data['Mapped-dups Gb']"></td>
                                                <td data-bind="text: $data['Overlap dup%']"></td>
                                                <td data-bind="text: $data['Net Gb']"></td>
                                                <td>
                                                    <span style="cursor: pointer" data-bind="click: $parent.toggleLaneletGraphs">&laquographs&raquo</span> 
                                                    <span style="cursor: pointer" data-bind="click: $parent.toggleLaneletStats">&laquostats&raquo</span>
                                                </td>
                                            </tr>
                                            <!-- ko if: display_graphs -->
                                                <tr>
                                                    <td colspan="20">
                                                        <div class="img-row" data-bind="foreach: qc_plots">
                                                            <div>
                                                                <img class="img-thumbnail" tabindex="1" data-bind="attr: { src: src, alt: alt, title: alt }">
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            <!-- /ko -->
                                            <!-- ko if: display_stats -->
                                                <tr>
                                                    <td colspan="20">
                                                        <table class="table table-bordered table-striped table-hover table-condensed small" style="margin-bottom: 0">
                                                            <tbody>
                                                                <tr>
                                                                    <th>Total Reads</th><td data-bind="text: $data['alignmentstats:reads']"></td>
                                                                    <th>Total Bases</th><td data-bind="text: $data['alignmentstats:bases']"></td>
                                                                    <th>Cycles</th><td data-bind="text: $data['alignmentstats:cycles']"></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>Reads paired</th><td data-bind="text: $data['alignmentstats:reads_paired']"></td>
                                                                    <th>Bases postclip</th><td data-bind="text: $data['alignmentstats:bases_postclip']"></td>
                                                                    <th>Duplication rate</th><td data-bind="text: $data['alignmentstats:duplication_rate']"></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>Reads mapped</th><td data-bind="text: $data['alignmentstats:reads_mapped']"></td>
                                                                    <th>Bases mapped</th><td data-bind="text: $data['alignmentstats:bases_mapped']"></td>
                                                                    <th>Error rate</th><td data-bind="text: $data['alignmentstats:error_rate']"></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>Reads mapped (rmdup)</th><td data-bind="text: $data['alignmentstats:reads_mapped_rmdup']"></td>
                                                                    <th>Bases mapped (rmdup)</th><td data-bind="text: $data['alignmentstats:bases_mapped_rmdup']"></td>
                                                                    <th></th><td></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                            <!-- /ko -->
                                        </tbody>
                                    <!-- /ko -->
                                    <!-- ko case: $default -->
                                        <tbody data-bind="foreach: viewNodes">
                                            <tr style="cursor: pointer" data-bind="foreach: $parent.viewColumnNames, click: $parent.showQCForNode">
                                                <td data-bind="text: $parent[$data]"></td>
                                            </tr>
                                        </tbody>
                                    <!-- /ko -->
                                <!-- /ko -->
                            </table>
                        </div>
                        <div class="panel-footer">
                            <small>
                                <!-- ko switch: selectedViewLabel -->
                                    <!-- ko case: 'Lanelet' -->
                                    <span data-bind="text: filteredLanelets().length"></span> rows
                                    <!-- /ko -->
                                    <!-- ko case: $default -->
                                    <span data-bind="text: viewNodes().length"></span> rows
                                    <!-- /ko -->
                                <!-- /ko -->
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <hr>
            
            <footer id="footer">
                <small>&copy; 2014-2016 Genome Research Limited.</small>
            </footer>
        </div>
        
        <script type="text/javascript">
            var router = new Simrou();
            $('[data-toggle="popover"]').popover();
            
            // viewmodel for logging in
            var livm = new ko.LogInViewModel();
            loadExternalKnockoutTemplates(function() {
                ko.applyBindings(livm, $('#nav')[0]);
            });
            
            // viewmodel for qc
            function QCViewModel() {
                var self = this;
                
                self.loading = ko.observableArray();
                self.errors = ko.observableArray();
                self.labels = ko.observableArray();
                self.labelProperties = {};
                self.viewLabels = ko.observableArray();
                self.adminToggle = ko.observable('->>>');
                self.adminUsers = ko.observable();
                self.groupAdmins = ko.observableArray();
                self.groupConfig = ko.observableArray();
                
                // toggle display of the admin well when user clicks the arrows
                self.toggleAdmin = function() {
                    if (self.adminToggle() == '->>>') {
                        self.adminToggle('<<<-');
                    }
                    else {
                        self.adminToggle('->>>');
                    }
                }
                
                // some selects show node properties sorted by the selected
                // property, so we'll have computed vars that build their arrays
                // using this function
                self.nodesToSelect = function(nodes, property, selectID) {
                    var arr = [];
                    if (property) {
                        property = property[0];
                        for (var i = 0; i < nodes().length; i++) {
                            var node = nodes()[i];
                            arr.push({ id: node['id'], property: node.properties[property] });
                        }
                        arr.sort(function(left, right) {
                            return left.property == right.property ? (left.id < right.id ? -1 : 1) : (left.property < right.property ? -1 : 1)
                        });
                    }
                    
                    setTimeout(function(){
                        $(selectID).multiselect('rebuild');
                    }, 10);
                    
                    return arr;
                }
                
                // required group and study selection vars
                self.groupNodes = ko.observableArray();
                self.selectedGroups = ko.observableArray();
                self.studyProperties = ko.observableArray();
                self.selectedStudyProperty = ko.observable();
                self.studyNodes = ko.observableArray();
                self.studyNodesForSelect = ko.computed(function() { return self.nodesToSelect(self.studyNodes, self.selectedStudyProperty(), '#studySelect'); });
                self.selectedStudies = ko.observableArray();
                
                // optional donor and sample selection vars
                self.donorProperties = ko.observableArray();
                self.selectedDonorProperty = ko.observable();
                self.donorNodes = ko.observableArray();
                self.donorNodesForSelect = ko.computed(function() { return self.nodesToSelect(self.donorNodes, self.selectedDonorProperty(), '#donorSelect'); });
                self.selectedDonors = ko.observableArray();
                self.sampleProperties = ko.observableArray();
                self.selectedSampleProperty = ko.observable();
                self.sampleNodes = ko.observableArray();
                self.sampleNodesForSelect = ko.computed(function() { return self.nodesToSelect(self.sampleNodes, self.selectedSampleProperty(), '#sampleSelect'); });
                self.selectedSamples = ko.observableArray();
                
                // view mode vars
                self.selectedViewLabel = ko.observable();
                self.viewNodes = ko.observableArray();
                self.showAllGraphs = ko.observable(false);
                self.showAllStats = ko.observable(false);
                self.laneletFilters = {
                    passed: ko.observable(true),
                    failed: ko.observable(true),
                    investigate: ko.observable(true),
                    gt_pending: ko.observable(true),
                    pending: ko.observable(true),
                    library: ko.observable(undefined),
                    run: ko.observable(undefined),
                    genotype: ko.observable('all'),
                    verify_bam_id: ko.observable('all'),
                    npg_status: ko.observable('all'),
                    auto_qc_status: ko.observable('all'),
                    raw_gb: ko.observable(undefined),
                    mapped_gb: ko.observable(undefined),
                    dup_percent: ko.observable(undefined),
                    mapped_dups_gb: ko.observable(undefined),
                    overlap_dup_percent: ko.observable(undefined),
                    net_gb: ko.observable(undefined),
                };
                self.filteredLanelets = self.viewNodes.filter(function(l) {
                    var pass = 
                        (self.laneletFilters['passed']() ? 1 : l['Pass'] == 0) &&
                        (self.laneletFilters['failed']() ? 1 : l['Fail'] == 0) &&
                        (self.laneletFilters['investigate']() ? 1 : l['Invst'] == 0) &&
                        (self.laneletFilters['gt_pending']() ? 1 : l['GTPend'] == 0) &&
                        (self.laneletFilters['pending']() ? 1 : l['Pend'] == 0) &&
                        (self.laneletFilters['library']() ? l['Library'].indexOf(self.laneletFilters['library']()) !== -1 : 1) &&
                        (self.laneletFilters['run']() ? l['Run'].indexOf(self.laneletFilters['run']()) !== -1 : 1) &&
                        (self.laneletFilters['genotype']() == 'all' ? 1 : l['Genotype'].startsWith(self.laneletFilters['genotype']())) &&
                        (self.laneletFilters['verify_bam_id']() == 'all' ? 1 : l['Verify Bam ID'].startsWith(self.laneletFilters['verify_bam_id']())) &&
                        (self.laneletFilters['npg_status']() == 'all' ? 1 : l['NPG Status'] == self.laneletFilters['npg_status']()) &&
                        (self.laneletFilters['auto_qc_status']() == 'all' ? 1 : l['Auto QC Status'] == self.laneletFilters['auto_qc_status']()) &&
                        (self.laneletFilters['raw_gb']() ? parseFloat(l['Raw Gb']) >= parseFloat(self.laneletFilters['raw_gb']()) : 1) &&
                        (self.laneletFilters['mapped_gb']() ? parseFloat(l['Mapped Gb']) >= parseFloat(self.laneletFilters['mapped_gb']()) : 1) &&
                        (self.laneletFilters['dup_percent']() ? parseFloat(l['Dup%']) <= parseFloat(self.laneletFilters['dup_percent']()) : 1) &&
                        (self.laneletFilters['mapped_dups_gb']() ? parseFloat(l['Mapped-dups Gb']) >= parseFloat(self.laneletFilters['mapped_dups_gb']()) : 1) &&
                        (self.laneletFilters['overlap_dup_percent']() ? parseFloat(l['Overlap dup%']) <= parseFloat(self.laneletFilters['overlap_dup_percent']()) : 1) &&
                        (self.laneletFilters['net_gb']() ? parseFloat(l['Net Gb']) >= parseFloat(self.laneletFilters['net_gb']()) : 1);
                    return pass;
                });
                
                // configure the multiselects
                $('#groupSelect').multiselect({
                    enableCaseInsensitiveFiltering: true,
                    maxHeight: 300,
                    nonSelectedText: 'Group...'
                });
                $('#studyPropertySelect').multiselect({
                    maxHeight: 300,
                    nonSelectedText: 'Property...'
                });
                $('#studySelect').multiselect({
                    includeSelectAllOption: true,
                    includeSelectAllIfMoreThan: 1,
                    enableCaseInsensitiveFiltering: true,
                    disableIfEmpty: true,
                    maxHeight: 300,
                    nonSelectedText: 'Study...'
                });
                $('#donorPropertySelect').multiselect({
                    maxHeight: 300,
                    nonSelectedText: 'Property...'
                });
                $('#donorSelect').multiselect({
                    includeSelectAllOption: true,
                    includeSelectAllIfMoreThan: 1,
                    enableCaseInsensitiveFiltering: true,
                    disableIfEmpty: true,
                    maxHeight: 300,
                    nonSelectedText: 'Donor...'
                });
                $('#samplePropertySelect').multiselect({
                    maxHeight: 300,
                    nonSelectedText: 'Property...'
                });
                $('#sampleSelect').multiselect({
                    includeSelectAllOption: true,
                    includeSelectAllIfMoreThan: 1,
                    enableCaseInsensitiveFiltering: true,
                    disableIfEmpty: true,
                    maxHeight: 300,
                    nonSelectedText: 'Sample...'
                });
                $('#viewSelect').multiselect({
                    maxHeight: 300,
                    nonSelectedText: 'View...'
                });
                
                // function to unset a selection
                self.deselect = function(selected, id) {
                    if (selected()) {
                        $(id).multiselect('deselect', selected());
                        selected(undefined);
                    }
                }
                
                // function to reset parts of the view
                self.reset = function(mode) {
                    self.deselect(self.selectedViewLabel, '#viewSelect');
                    self.viewNodes.removeAll();
                    
                    if (mode > 1) {
                        self.deselect(self.selectedSampleProperty, '#samplePropertySelect');
                        self.selectedSamples.removeAll();
                        self.sampleNodes.removeAll();
                    }
                    
                    if (mode > 2) {
                        self.deselect(self.selectedDonorProperty, '#donorPropertySelect');
                        self.selectedDonors.removeAll();
                        self.donorNodes.removeAll();
                    }
                    
                    if (mode > 3) {
                        self.deselect(self.selectedStudyProperty, '#studyPropertySelect');
                        self.selectedStudies.removeAll();
                        self.studyNodes.removeAll();
                    }
                }
                
                // get admin details (ignore errors from it to avoid having 2
                // not-logged-in errors)
                self.errorsIgnored =  ko.observableArray();
                getQCGraphData('qc_website_admin', { }, { adminUsers: self.adminUsers, groupAdmins: self.groupAdmins, groupConfig: self.groupConfig }, self.loading, self.errorsIgnored);
                
                // when admin-stuff changes, update the graph db
                self.adminUsers.subscribe(function(newValue) {
                    if (newValue && newValue != '') {
                        getQCGraphData('qc_website_admin', { admins: newValue }, { adminUsers: self.adminUsers }, self.loading, self.errors);
                    }
                });
                self.updateGroupAdmins = function(data) {
                    getQCGraphData('qc_website_admin', { group: data.group, group_admins: data.users }, { groupAdmins: self.groupAdmins }, self.loading, self.errors);
                }
                self.updateGroupConfig = function(data) {
                    getQCGraphData('qc_website_admin', { group: data.group, group_qc_fail_reasons: data.qc_fail_reasons }, { groupConfig: self.groupConfig }, self.loading, self.errors);
                }
                
                // get all the schema details from the db
                getQCGraphData('labels', { }, { resultStore: self.labels, labelProperties: self.labelProperties, viewLabels: self.viewLabels, groupNodes: self.groupNodes, studyProperties: self.studyProperties, donorProperties: self.donorProperties, sampleProperties: self.sampleProperties }, self.loading, self.errors);
                
                // when the user selects a study property, if they have also
                // already chosen a group, then fill in the studyPropertyValues
                self.selectedStudyProperty.subscribe(function(newValue) {
                    if (newValue && newValue != '' && self.selectedGroups().length && ! self.studyNodes().length) {
                        getQCGraphData('nodes_of_label', { label: 'Study', groups: self.selectedGroups() }, { resultStore: self.studyNodes }, self.loading, self.errors);
                    }
                });
                
                // when the user changes groups or studies we need to reset things
                self.selectedGroups.subscribe(function(newValue) {
                    self.reset(4);
                });
                self.selectedStudies.subscribe(function(newValue) {
                    self.reset(3);
                });
                
                // when donor or sample property is changed, fill in the values
                // to select from
                self.selectedDonorProperty.subscribe(function(newValue) {
                    if (newValue && newValue != '' && ! self.donorNodes().length) {
                        getQCGraphData('nodes_of_label', { label: 'Donor', groups: self.selectedGroups(), studies: self.selectedStudies() }, { resultStore: self.donorNodes }, self.loading, self.errors);
                    }
                });
                self.selectedSampleProperty.subscribe(function(newValue) {
                    if (newValue && newValue != '' && ! self.sampleNodes().length) {
                        var opts = {label: 'Sample', groups: self.selectedGroups(), studies: self.selectedStudies()};
                        if (self.selectedDonors().length) {
                            opts['donors'] = self.selectedDonors();
                        }
                        getQCGraphData('nodes_of_label', opts, { resultStore: self.sampleNodes }, self.loading, self.errors);
                    }
                });
                
                // when donor is changed, update samples
                self.selectedDonors.subscribe(function(newValue) {
                    self.reset(2);
                    
                    if (newValue && newValue != '') {
                        getQCGraphData('nodes_of_label', { label: 'Sample', groups: self.selectedGroups(), studies: self.selectedStudies(), donors: newValue }, { resultStore: self.sampleNodes }, self.loading, self.errors);
                    }
                });
                
                // when samples change, reset the view
                self.selectedSamples.subscribe(function(newValue) {
                    self.reset(1);
                });
                
                // when the user selects a view, get all nodes with that label,
                // filtered based on group, studies and any other selections
                self.selectedViewLabel.subscribe(function(newValue) {
                    if (newValue && newValue != '' && self.selectedGroups().length && self.selectedStudies().length) {
                        self.viewNodes.removeAll();
                        var loc = '/groups:' + self.selectedGroups() + '/studies:' + self.selectedStudies();
                        var opts = {label: newValue[0], groups: self.selectedGroups(), studies: self.selectedStudies()};
                        if (self.selectedDonors().length) {
                            opts['donors'] = self.selectedDonors();
                            loc = loc + '/donors:' + self.selectedDonors();
                        }
                        else {
                            loc = loc + '/donors:all';
                        }
                        if (self.selectedSamples().length) {
                            opts['samples'] = self.selectedSamples();
                            loc = loc + '/samples:' + self.selectedSamples();
                        }
                        else {
                            loc = loc + '/samples:all';
                        }
                        getQCGraphData('nodes_of_label', opts, { resultStore: self.viewNodes, flatten: true }, self.loading, self.errors);
                        
                        // and set the browser url to make this selection
                        // bookmarkable and included in the history
                        loc = loc + '/view:' + newValue;
                        if (location.hash != '#' + loc) {
                            location.hash = loc;
                        }
                    }
                });
                
                // client-side route which fills in the selection dropdowns
                // based on the user changing the url in the browser directly
                // (to enable bookmarkability and history)
                route = router.addRoute('/groups\::groups/studies\::studies/donors\::donors/samples\::samples/view\::view');
                route.get(function(event, params) {
                    var groups = splitToInts(params.groups);
                    var studies = splitToInts(params.studies);
                    var donors = params.donors == 'all' ? [] : splitToInts(params.donors);
                    var samples = params.samples == 'all' ? [] : splitToInts(params.samples);
                    if (! arraysEqual(groups, self.selectedGroups()) || ! arraysEqual(studies, self.selectedStudies()) || ! arraysEqual(donors, self.selectedDonors()) || ! arraysEqual(samples, self.selectedSamples()) || params.view != self.selectedViewLabel()) {
                        self.reset(4);
                        
                        // simulate selecting the desired things from the
                        // selects, waiting each time for the selects to
                        // populate
                        runWhenPopulated(self.groupNodes, function() {
                            self.selectedGroups(groups);
                            self.selectedStudyProperty(['name']);
                            $('#studyPropertySelect').multiselect('select', self.selectedStudyProperty());
                            
                            runWhenPopulated(self.studyNodes, function() {
                                self.selectedStudies(studies);
                                
                                if (donors.length) {
                                    self.selectedDonorProperty(['example_sample']);
                                    $('#donorPropertySelect').multiselect('select', self.selectedDonorProperty());
                                    
                                    runWhenPopulated(self.donorNodes, function() {
                                        self.selectedDonors(donors);
                                        
                                        if (samples.length) {
                                            self.selectedSampleProperty(['public_name']);
                                            $('#samplePropertySelect').multiselect('select', self.selectedSampleProperty());
                                            
                                            runWhenPopulated(self.sampleNodes, function() {
                                                self.selectedSamples(samples);
                                                self.selectedViewLabel([params.view]);
                                                $('#viewSelect').multiselect('select', self.selectedViewLabel());
                                            });
                                        }
                                        else {
                                            self.selectedViewLabel([params.view]);
                                            $('#viewSelect').multiselect('select', self.selectedViewLabel());
                                        }
                                    });
                                }
                                else if (samples.length) {
                                    self.selectedSampleProperty(['public_name']);
                                    $('#samplePropertySelect').multiselect('select', self.selectedSampleProperty());
                                    
                                    runWhenPopulated(self.sampleNodes, function() {
                                        self.selectedSamples(samples);
                                        self.selectedViewLabel([params.view]);
                                        $('#viewSelect').multiselect('select', self.selectedViewLabel());
                                    });
                                }
                                else {
                                    self.selectedViewLabel([params.view]);
                                    $('#viewSelect').multiselect('select', self.selectedViewLabel());
                                }
                            });
                        });
                    }
                });
                
                // dynamic view table columns
                self.viewColumnNames = ko.computed(function () {
                    if (self.viewNodes().length === 0) return [];
                    var props = [];
                    
                    if (self.selectedViewLabel() == 'Donor') {
                        // put the desired columns in our desired order
                        props.push('ID');
                        props.push('Example Sample');
                        props.push('Sample Creation Date');
                        props.push('QCToDo(Fluidigm)');
                        props.push('QCToDo(Genotyping)');
                        props.push('QCToDo(All)');
                    }
                    else if (self.selectedViewLabel() == 'Lanelet') {
                        props.push('Pass');
                        props.push('Fail');
                        props.push('Invst');
                        props.push('GTPend');
                        props.push('Pend');
                        props.push('Individual');
                        props.push('Sample');
                        props.push('Library');
                        props.push('Run');
                        props.push('Genotype');
                        props.push('Verify Bam ID');
                        props.push('NPG Status');
                        props.push('Auto QC Status');
                        props.push('Raw Gb');
                        props.push('Mapped Gb');
                        props.push('Dup%');
                        props.push('Mapped-dups Gb');
                        props.push('Overlap dup%');
                        props.push('Net Gb');
                    }
                    else {
                        var obj = self.viewNodes()[0];
                        for (var name in obj) {
                            if (name == 'node_id' || name == 'node_label') {
                                continue;
                            }
                            props.push(name);
                        }
                    }
                    return props;
                });
                
                // when a node in the view table is clicked on, open a new tab
                // with the results
                self.showQCForNode = function(node) {
                    var nodeID = +node['node_id'];
                    var nodeLabel = node['node_label'];
                    
                    if (nodeLabel == 'Donor') {
                        window.open('/pages/vrtrack_qc/donor.html?id=' + nodeID, '_blank', '', false);
                    }
                    
                    return true;
                }
                
                // when a lanelet qc status is changed, set in db and update
                // the booleans that enable column sorting
                self.qcStatusToCol = {passed: 'Pass', failed: 'Fail', investigate: 'Invst', 'gt_pending': 'GTPend', pending: 'Pend'};
                self.changeQCStatus = function(laneletStatus, lanelet) {
                    var oldStatus = lanelet['qcgrind_qc_status'];
                    var run = lanelet['Run'];
                    
                    vrpipeRestMethod('qc', 'set_lanelet_qc_status', { lane: run, status: laneletStatus }, self.loading, self.errors, function(data) {
                        if (data['success']) {
                            lanelet['qcgrind_qc_status'] = laneletStatus;
                            lanelet[self.qcStatusToCol[oldStatus]] = 0;
                            lanelet[self.qcStatusToCol[laneletStatus]] = 1;
                            
                            // also colour the radio as indication of what has
                            // been set this session
                            var id = run + '_' + oldStatus;
                            var radioDiv = document.getElementById(id);
                            radioDiv.style.backgroundColor = 'transparent';
                            id = run + '_' + laneletStatus;
                            radioDiv = document.getElementById(id);
                            radioDiv.style.backgroundColor = 'yellow';
                        }
                    });
                    
                    return true;
                }
                
                // lanelet view has various popups for different columns
                self.genotypePopover = function(lane) {
                    if (lane.hasOwnProperty('gtcheckdata:bam_call_string')) {
                        var html = '<table class="table table-bordered table-striped table-condensed small" style="margin-bottom: 0"><tbody>';
                    
                        html += '<tr><th>BAM calls</th>';
                        var bCalls = lane['gtcheckdata:bam_call_string'];
                        for (var i = 0, bCallsLength = bCalls.length; i < bCallsLength; i += 2) {
                            html += '<td>' + bCalls.substring(i, i + 2) + '</td>';
                        }
                        html += '</tr>';
                        
                        html += '<tr><th>Call depths</th>';
                        var depths = lane['gtcheckdata:bam_gt_depths_string'].split(';');
                        for (var i = 0, depthsLength = depths.length; i < depthsLength; i++) {
                            html += '<td>' + depths[i] + '</td>';
                        }
                        html += '</tr>';
                        
                        html += '</tbody></table>';
                        return html;
                    }
                    else {
                        return '<p>no genotype result data available</p>';
                    }
                }
                self.verifyPopover = function(lane) {
                    var html = '<table class="table table-bordered table-striped table-condensed small" style="margin-bottom: 0"><tbody>';
                    
                    html += '<tr><th>Number of SNPs</th><td>' + lane['verifybamiddata:number_of_snps'] + '</td></tr>';
                    html += '<tr><th>Average Depth</th><td>' + lane['verifybamiddata:avg_depth'] + '</td></tr>';
                    html += '<tr><th>Freemix</th><td>' + lane['verifybamiddata:freemix'] + '</td></tr>';
                    html += '<tr><th>FreeLK0</th><td>' + lane['verifybamiddata:freeLK0'] + '</td></tr>';
                    html += '<tr><th>FreeLK1</th><td>' + lane['verifybamiddata:freeLK1'] + '</td></tr>';
                    
                    html += '</tbody></table>';
                    return html;
                }
                self.toggleLaneletGraphs = function (node) {
                    node['display_graphs'](!node['display_graphs']());
                };
                self.toggleLaneletStats = function (node) {
                    node['display_stats'](!node['display_stats']());
                };
                self.showAllGraphs.subscribe(function(newValue) {
                    ko.utils.arrayForEach(self.viewNodes(), function(node) {
                        node['display_graphs'](newValue);
                    });
                });
                self.showAllStats.subscribe(function(newValue) {
                    ko.utils.arrayForEach(self.viewNodes(), function(node) {
                        node['display_stats'](newValue);
                    });
                });
            }
            
            var qcvm = new QCViewModel();
            ko.applyBindings(qcvm, $('#qc')[0]);
            
            router.start('/');
        </script>
    </body>
</html>
